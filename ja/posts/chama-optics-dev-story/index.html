<!doctype html><html lang=ja dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="ja-JP"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Chama Optics 開発記 &#183; Jinwoo Park Blog</title><meta name=title content="Chama Optics 開発記 &#183; Jinwoo Park Blog"><meta name=description content="EXIF ベースの写真フレーム＋顔自動認識アプリ、Rust コアでデスクトップからモバイルまで"><meta name=keywords content="Rust,iOS,Cross-Platform,EXIF,"><link rel=canonical href=https://pmnxis.github.io/ja/posts/chama-optics-dev-story/><meta property="og:url" content="https://pmnxis.github.io/ja/posts/chama-optics-dev-story/"><meta property="og:site_name" content="Jinwoo Park Blog"><meta property="og:title" content="Chama Optics 開発記"><meta property="og:description" content="EXIF ベースの写真フレーム＋顔自動認識アプリ、Rust コアでデスクトップからモバイルまで"><meta property="og:locale" content="ja_JP"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-14T00:00:00+09:00"><meta property="article:modified_time" content="2026-02-14T00:00:00+09:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="IOS"><meta property="article:tag" content="Cross-Platform"><meta property="article:tag" content="EXIF"><meta property="og:image" content="https://pmnxis.github.io/en/posts/chama-optics-dev-story/feature.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pmnxis.github.io/en/posts/chama-optics-dev-story/feature.webp"><meta name=twitter:title content="Chama Optics 開発記"><meta name=twitter:description content="EXIF ベースの写真フレーム＋顔自動認識アプリ、Rust コアでデスクトップからモバイルまで"><meta name=google-site-verification content="VmKxOzBA6bj36Pwan0cjJGtyjeD7hzi9UDxXJ4kCjhI"><link type=text/css rel=stylesheet href=/css/main.bundle.min.b5bc3f4587655153415b7825fd1716f97df9c99f87c23f81146f4dd4f9f49f04ad031e3b5f0ee5c0416707a1455ca2cfa8fc1f3a19ece1486b0126dcd310a63e.css integrity="sha512-tbw/RYdlUVNBW3gl/RcW+X35yZ+Hwj+BFG9N1Pn0nwStAx47Xw7lwEFnB6FFXKLPqPwfOhns4UhrASbc0xCmPg=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.bdda7dece6cbaf08deef7d254f7f842f3261c2524d247905127c9a20decc03f1011a2950048464c79272c1ce0705a49a41147f39f2b95163bb71d404b33263ef.js integrity="sha512-vdp97ObLrwje730lT3+ELzJhwlJNJHkFEnyaIN7MA/EBGilQBIRkx5Jywc4HBaSaQRR/OfK5UWO7cdQEszJj7w==" data-copy=コピー data-copied=コピーしました></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Chama Optics 開発記","headline":"Chama Optics 開発記","description":"EXIF ベースの写真フレーム＋顔自動認識アプリ、Rust コアでデスクトップからモバイルまで","inLanguage":"ja-JP","url":"https://pmnxis.github.io/ja/posts/chama-optics-dev-story/","author":{"@type":"Person","name":""},"copyrightYear":"2026","dateCreated":"2026-02-14T00:00:00\u002b09:00","datePublished":"2026-02-14T00:00:00\u002b09:00","dateModified":"2026-02-14T00:00:00\u002b09:00","keywords":["Rust","iOS","Cross-Platform","EXIF"],"mainEntityOfPage":"true","wordCount":"22014"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
メインコンテンツへスキップ</a></div><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><div><a href=/ja/ class=flex><span class=sr-only>Jinwoo Park Blog</span>
<img src=/img/LambdaEE.png width=295 height=182 class="logo max-h-20 max-w-20 object-scale-down object-left nozoom" alt></a></div><a href=/ja/ class="text-base font-medium truncate min-w-0 shrink">Jinwoo Park Blog</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/ko/posts/ class="flex items-center bf-icon-color-hover" aria-label=Blog title=Posts><span class="text-base font-medium break-normal">Blog
</span></a><a href=/ko/tags/ class="flex items-center bf-icon-color-hover" aria-label=Tags title=Tags><span class="text-base font-medium break-normal">Tags
</span></a><a href=/ko/categories/ class="flex items-center bf-icon-color-hover" aria-label=Categories title=Categories><span class="text-base font-medium break-normal">Categories
</span></a><a href=https://github.com/pmnxis target=_blank class="flex items-center bf-icon-color-hover" aria-label=GitHub title><span class="text-base font-medium break-normal">GitHub</span></a><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Chama Optics 開発記">JA</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/ko/posts/chama-optics-dev-story/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Chama Optics 개발기">KO
</span></a><a href=/ja/posts/chama-optics-dev-story/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Chama Optics 開発記">JA
</span></a><a href=/en/posts/chama-optics-dev-story/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Chama Optics Development Story">EN</span></a></li></ul></div><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="検索 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="検索 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/ko/posts/ aria-label=Blog class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Blog</span></a></div><div class=px-2><a href=/ko/tags/ aria-label=Tags class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Tags class="text-2xl font-bold tracking-tight">Tags</span></a></div><div class=px-2><a href=/ko/categories/ aria-label=Categories class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Categories class="text-2xl font-bold tracking-tight">Categories</span></a></div><div class=px-2><a href=https://github.com/pmnxis aria-label=GitHub target=_blank class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title class="text-2xl font-bold tracking-tight">GitHub</span></a></div><div class="flex flex-wrap items-center [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl! [&_.translation_button_span]:text-base! [&_.translation_.menuhide_span]:text-sm! gap-x-6 ps-2 mt-8 pt-8 border-t bf-border-color"><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Chama Optics 開発記">JA</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/ko/posts/chama-optics-dev-story/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Chama Optics 개발기">KO
</span></a><a href=/ja/posts/chama-optics-dev-story/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Chama Optics 開発記">JA
</span></a><a href=/en/posts/chama-optics-dev-story/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Chama Optics Development Story">EN</span></a></li></ul></div></div></nav></div></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Chama Optics 開発記</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-02-14T00:00:00+09:00>2026年2月14日</time><span class="px-2 text-primary-500">&#183;</span><span title=読むのに必要な時間>44 分</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/ja/categories/chama-optics/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Chama Optics
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/ja/tags/rust/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Rust
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/ja/tags/ios/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">IOS
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/ja/tags/cross-platform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cross-Platform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/ja/tags/exif/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">EXIF</span></span></a></div></div><div class="flex author"><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目次</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#プロジェクト紹介>プロジェクト紹介</a></li><li><a href=#始まりexifフレームをもっと手軽に>始まり：EXIFフレームをもっと手軽に</a></li><li><a href=#方向転換会場でmacbookは開けないだろ>方向転換：「会場でMacBookは開けないだろ」</a><ul><li><a href=#イベント文化の違い--animenycで感じたこと>イベント文化の違い ―― AnimeNYCで感じたこと</a></li><li><a href=#間もなく開催のホロライブエキスポ>間もなく開催のホロライブエキスポ</a></li><li><a href=#周囲からのリクエスト>周囲からのリクエスト</a></li></ul></li><li><a href=#アーキテクチャデスクトップからモバイルへ>アーキテクチャ：デスクトップからモバイルへ</a></li><li><a href=#web版を断念した理由>Web版を断念した理由</a><ul><li><a href=#heifwasmの上にwasmその間にjs>HEIF：WASMの上にWASM、その間にJS</a></li><li><a href=#drag--dropデスクトップ開発者の期待と現実>Drag & Drop：デスクトップ開発者の期待と現実</a></li><li><a href=#正直cとrustしか使えない>正直、CとRustしか使えない</a></li></ul></li><li><a href=#タイムラインで見る開発の旅>タイムラインで見る開発の旅</a><ul><li><a href=#v010v011-2025-10-1921--初のプレリリース>v0.1.0~v0.1.1 (2025-10-19~21) ―― 初のプレリリース</a></li><li><a href=#v012v016-2025-10-2711-24--テーマ拡張とウォーターマーク>v0.1.2~v0.1.6 (2025-10-27~11-24) ―― テーマ拡張とウォーターマーク</a></li><li><a href=#v017-2025-11-2612-19--cjkレンダリング改善とオープンソース貢献>v0.1.7 (2025-11-26~12-19) ―― CJKレンダリング改善とオープンソース貢献</a></li><li><a href=#v018-2025-12-2527--uiリニューアルとパフォーマンス改善>v0.1.8 (2025-12-25~27) ―― UIリニューアルとパフォーマンス改善</a></li><li><a href=#v019-2026-01-1802-04--顔認識lutios初配布>v0.1.9 (2026-01-18~02-04) ―― 顔認識、LUT、iOS初配布</a></li></ul></li><li><a href=#技術的チャレンジと解決策>技術的チャレンジと解決策</a><ul><li><a href=#1-クロスプラットフォームffiの複雑さ>1. クロスプラットフォームFFIの複雑さ</a></li><li><a href=#2-exifパースの尽きない変数>2. EXIFパースの尽きない変数</a></li><li><a href=#3-makernoteパースメーカー別撮影設定の抽出>3. MakerNoteパース：メーカー別撮影設定の抽出</a><ul><li><a href=#exif-ifdエントリ構造とmakernoteのoffset問題>EXIF IFDエントリ構造とMakerNoteのoffset問題</a></li></ul></li><li><a href=#4-カメラメーカーロゴシステムcsv--buildrs--バイナリ埋め込み>4. カメラメーカーロゴシステム：CSV → build.rs → バイナリ埋め込み</a><ul><li><a href=#コンパイルタイムcsvからsvgダウンロード埋め込み>コンパイルタイム：CSVからSVGダウンロード＆埋め込み</a></li><li><a href=#ランタイムexif--ロゴマッチング--svgラスタライズ>ランタイム：EXIF → ロゴマッチング → SVGラスタライズ</a></li></ul></li><li><a href=#5-cjkフォントレンダリングと可変フォントvariable-font最適化>5. CJKフォントレンダリングと可変フォント（Variable Font）最適化</a><ul><li><a href=#可変フォント-weight-リマッピング>可変フォント weight リマッピング</a></li><li><a href=#複数のフォントファイルを一つに統合--ファイルサイズの絶対的な削減>複数のフォントファイルを一つに統合 ―― ファイルサイズの絶対的な削減</a></li><li><a href=#eguiでの可変フォント-weightセレクティブロード>eguiでの可変フォント weightセレクティブロード</a></li><li><a href=#ビルトインフォントとシステムフォント>ビルトインフォントとシステムフォント</a></li><li><a href=#font-kit-macos-メモリ暴走のデバッグ>font-kit macOS メモリ暴走のデバッグ</a></li></ul></li><li><a href=#6-lutカラーグレーディングwagahai-lutの最適化哲学>6. LUTカラーグレーディング：wagahai-lutの最適化哲学</a><ul><li><a href=#cube-lutとは>CUBE LUTとは？</a></li><li><a href=#wagahai-lutの最適化戦略>wagahai-lutの最適化戦略</a></li><li><a href=#ベンチマーク結果>ベンチマーク結果</a></li></ul></li><li><a href=#7-デスクトップ顔認識speed-modeとスライディングウィンドウアルゴリズム>7. デスクトップ顔認識：Speed Modeとスライディングウィンドウアルゴリズム</a><ul><li><a href=#fastest>Fastest</a></li><li><a href=#fast>Fast</a></li><li><a href=#normal>Normal</a></li><li><a href=#slow>Slow</a></li><li><a href=#slowest>Slowest</a></li></ul></li><li><a href=#8-iosネイティブ統合>8. iOSネイティブ統合</a></li><li><a href=#9-mpfおよび内蔵プレビュー画像の抽出>9. MPFおよび内蔵プレビュー画像の抽出</a><ul><li><a href=#jpegの中に隠された画像たち>JPEGの中に隠された画像たち</a></li><li><a href=#なぜmpfプレビューが重要なのかメモリとパフォーマンス>なぜMPFプレビューが重要なのか：メモリとパフォーマンス</a></li></ul></li><li><a href=#10-heifheicデコーダプラットフォーム別戦略>10. HEIF/HEICデコーダ：プラットフォーム別戦略</a></li><li><a href=#11-テーマパラメータシステムrust--json--プラットフォーム別ui>11. テーマパラメータシステム：Rust → JSON → プラットフォーム別UI</a></li></ul></li><li><a href=#オープンソース貢献活動>オープンソース貢献活動</a></li><li><a href=#リリースまとめ>リリースまとめ</a></li><li><a href=#aiと共にプログラミングバイブコーディング>AIと共にプログラミング（バイブコーディング？）</a></li><li><a href=#今後の計画>今後の計画</a></li><li><a href=#参考文献および引用>参考文献および引用</a><ul><li><ul><li><a href=#標準文書>標準文書</a></li><li><a href=#ライブラリおよびフレームワーク>ライブラリおよびフレームワーク</a></li><li><a href=#参考資料>参考資料</a></li></ul></li></ul></li><li><a href=#special-thanks>Special Thanks</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目次</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#プロジェクト紹介>プロジェクト紹介</a></li><li><a href=#始まりexifフレームをもっと手軽に>始まり：EXIFフレームをもっと手軽に</a></li><li><a href=#方向転換会場でmacbookは開けないだろ>方向転換：「会場でMacBookは開けないだろ」</a><ul><li><a href=#イベント文化の違い--animenycで感じたこと>イベント文化の違い ―― AnimeNYCで感じたこと</a></li><li><a href=#間もなく開催のホロライブエキスポ>間もなく開催のホロライブエキスポ</a></li><li><a href=#周囲からのリクエスト>周囲からのリクエスト</a></li></ul></li><li><a href=#アーキテクチャデスクトップからモバイルへ>アーキテクチャ：デスクトップからモバイルへ</a></li><li><a href=#web版を断念した理由>Web版を断念した理由</a><ul><li><a href=#heifwasmの上にwasmその間にjs>HEIF：WASMの上にWASM、その間にJS</a></li><li><a href=#drag--dropデスクトップ開発者の期待と現実>Drag & Drop：デスクトップ開発者の期待と現実</a></li><li><a href=#正直cとrustしか使えない>正直、CとRustしか使えない</a></li></ul></li><li><a href=#タイムラインで見る開発の旅>タイムラインで見る開発の旅</a><ul><li><a href=#v010v011-2025-10-1921--初のプレリリース>v0.1.0~v0.1.1 (2025-10-19~21) ―― 初のプレリリース</a></li><li><a href=#v012v016-2025-10-2711-24--テーマ拡張とウォーターマーク>v0.1.2~v0.1.6 (2025-10-27~11-24) ―― テーマ拡張とウォーターマーク</a></li><li><a href=#v017-2025-11-2612-19--cjkレンダリング改善とオープンソース貢献>v0.1.7 (2025-11-26~12-19) ―― CJKレンダリング改善とオープンソース貢献</a></li><li><a href=#v018-2025-12-2527--uiリニューアルとパフォーマンス改善>v0.1.8 (2025-12-25~27) ―― UIリニューアルとパフォーマンス改善</a></li><li><a href=#v019-2026-01-1802-04--顔認識lutios初配布>v0.1.9 (2026-01-18~02-04) ―― 顔認識、LUT、iOS初配布</a></li></ul></li><li><a href=#技術的チャレンジと解決策>技術的チャレンジと解決策</a><ul><li><a href=#1-クロスプラットフォームffiの複雑さ>1. クロスプラットフォームFFIの複雑さ</a></li><li><a href=#2-exifパースの尽きない変数>2. EXIFパースの尽きない変数</a></li><li><a href=#3-makernoteパースメーカー別撮影設定の抽出>3. MakerNoteパース：メーカー別撮影設定の抽出</a><ul><li><a href=#exif-ifdエントリ構造とmakernoteのoffset問題>EXIF IFDエントリ構造とMakerNoteのoffset問題</a></li></ul></li><li><a href=#4-カメラメーカーロゴシステムcsv--buildrs--バイナリ埋め込み>4. カメラメーカーロゴシステム：CSV → build.rs → バイナリ埋め込み</a><ul><li><a href=#コンパイルタイムcsvからsvgダウンロード埋め込み>コンパイルタイム：CSVからSVGダウンロード＆埋め込み</a></li><li><a href=#ランタイムexif--ロゴマッチング--svgラスタライズ>ランタイム：EXIF → ロゴマッチング → SVGラスタライズ</a></li></ul></li><li><a href=#5-cjkフォントレンダリングと可変フォントvariable-font最適化>5. CJKフォントレンダリングと可変フォント（Variable Font）最適化</a><ul><li><a href=#可変フォント-weight-リマッピング>可変フォント weight リマッピング</a></li><li><a href=#複数のフォントファイルを一つに統合--ファイルサイズの絶対的な削減>複数のフォントファイルを一つに統合 ―― ファイルサイズの絶対的な削減</a></li><li><a href=#eguiでの可変フォント-weightセレクティブロード>eguiでの可変フォント weightセレクティブロード</a></li><li><a href=#ビルトインフォントとシステムフォント>ビルトインフォントとシステムフォント</a></li><li><a href=#font-kit-macos-メモリ暴走のデバッグ>font-kit macOS メモリ暴走のデバッグ</a></li></ul></li><li><a href=#6-lutカラーグレーディングwagahai-lutの最適化哲学>6. LUTカラーグレーディング：wagahai-lutの最適化哲学</a><ul><li><a href=#cube-lutとは>CUBE LUTとは？</a></li><li><a href=#wagahai-lutの最適化戦略>wagahai-lutの最適化戦略</a></li><li><a href=#ベンチマーク結果>ベンチマーク結果</a></li></ul></li><li><a href=#7-デスクトップ顔認識speed-modeとスライディングウィンドウアルゴリズム>7. デスクトップ顔認識：Speed Modeとスライディングウィンドウアルゴリズム</a><ul><li><a href=#fastest>Fastest</a></li><li><a href=#fast>Fast</a></li><li><a href=#normal>Normal</a></li><li><a href=#slow>Slow</a></li><li><a href=#slowest>Slowest</a></li></ul></li><li><a href=#8-iosネイティブ統合>8. iOSネイティブ統合</a></li><li><a href=#9-mpfおよび内蔵プレビュー画像の抽出>9. MPFおよび内蔵プレビュー画像の抽出</a><ul><li><a href=#jpegの中に隠された画像たち>JPEGの中に隠された画像たち</a></li><li><a href=#なぜmpfプレビューが重要なのかメモリとパフォーマンス>なぜMPFプレビューが重要なのか：メモリとパフォーマンス</a></li></ul></li><li><a href=#10-heifheicデコーダプラットフォーム別戦略>10. HEIF/HEICデコーダ：プラットフォーム別戦略</a></li><li><a href=#11-テーマパラメータシステムrust--json--プラットフォーム別ui>11. テーマパラメータシステム：Rust → JSON → プラットフォーム別UI</a></li></ul></li><li><a href=#オープンソース貢献活動>オープンソース貢献活動</a></li><li><a href=#リリースまとめ>リリースまとめ</a></li><li><a href=#aiと共にプログラミングバイブコーディング>AIと共にプログラミング（バイブコーディング？）</a></li><li><a href=#今後の計画>今後の計画</a></li><li><a href=#参考文献および引用>参考文献および引用</a><ul><li><ul><li><a href=#標準文書>標準文書</a></li><li><a href=#ライブラリおよびフレームワーク>ライブラリおよびフレームワーク</a></li><li><a href=#参考資料>参考資料</a></li></ul></li></ul></li><li><a href=#special-thanks>Special Thanks</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><blockquote><p>EXIF ベースの写真フレーム＋顔自動認識アプリ、Rust コアでデスクトップからモバイルまで</p></blockquote><p>このブログにオタク全開の記事を堂々と書くのは、おそらく今回が初めてだと思います。
正直、この記事を書き始めてからかなり経つのですが、読者を開発者に向けるべきかVTuberオタクに向けるべきか掴めませんでした。
結局、意識の流れに任せて開発・貢献してきたことを並べていくことにしました。</p><p>そこで、このブログでは主にRust Embeddedを扱っており、以前 <a href=https://github.com/pmnxis/billmock-app-rs target=_blank rel=noreferrer>billmock-app-rs</a> というRust Embedded量産プロジェクトを手がけたことがあります。</p><p>この記事では <a href=https://github.com/pmnxis/chama-optics target=_blank rel=noreferrer>Chama Optics</a> の開発過程を紹介します。</p><p>2026年2月最終週に <strong>0.2.0</strong> で iOS / Android / macOS / Linux / Windows の正式リリースを予定しており、App Store・Google Play 承認前の開発過程を記述しています。</p><blockquote><p>🌐 <a href=/ko/posts/chama-optics-dev-story/>한국어 아티클</a> | <a href=/en/posts/chama-optics-dev-story/>English Article</a></p></blockquote><hr><h2 class="relative group">プロジェクト紹介<div id=プロジェクト紹介 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e7%b4%b9%e4%bb%8b aria-label=アンカー>#</a></span></h2><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=auto alt="Chama Optics" width=1280 height=720 src=/en/posts/chama-optics-dev-story/haachama-optics_hu_c9db7982d9164695.webp srcset="/en/posts/chama-optics-dev-story/haachama-optics_hu_c9db7982d9164695.webp 800w, /en/posts/chama-optics-dev-story/haachama-optics.webp 1280w" sizes="(min-width: 768px) 50vw, 65vw" data-zoom-src=/en/posts/chama-optics-dev-story/haachama-optics.webp></figure></p><p><strong>Chama Optics</strong> は、DSLR/ミラーレスカメラで撮影した写真のEXIFデータを解析し、さまざまなテーマフレームを適用して、ウォーターマーク・モザイク・ステッカーなどのエフェクトを追加できる写真後処理プログラムです。「Chama」という名前は、旅系VTuber Akai Haato（赤井はあと）のニックネームに由来しています。</p><p>数多くのモバイル端末を使ってきましたが、自分の関心はいつも電子機器を<strong>作る</strong>側にあり、スマホアプリ開発とは縁遠かったです。そんな自分がHololive JP 1期生の赤井はあと（HAACHAMA）のファンとしてオタク生活をする中で、組み込みではないソフトウェア開発領域で初めてのプロジェクトを始めることになりました。</p><p>このプログラムを最初に構想したのは2025年3月からです。
当時はWebアプリとして動作させたいと考えており、ライブラリのテスト、WASM環境のテスト、libheifのポーティングなどを進めていました。
2025年8月、東京での天音かなたソロライブ LOCK-ON と、米国ニューヨークでのAnimeNYC World Tour + EN Concert（All for one）に行った後、写真を素早く整理してWEBPに圧縮して投稿する必要性を痛感しました。
同時に赤井はあとも最近写真を撮ることが好きで、メンバーシップ限定投稿で自分のカメラを見せたり、推し活はあとん日記（<a href=https://x.com/hashtag/%E6%8E%A8%E3%81%97%E6%B4%BB%E3%81%AF%E3%81%82%E3%81%A8%E3%82%93%E6%97%A5%E8%A8%98 target=_blank rel=noreferrer>#推し活はあとん日記</a>）で写真投稿を促していたので、はあと（HAACHAMA）の名前でアプリを一つ開発してあげたかったです。</p><table><thead><tr><th>最近の3D Live</th><th>Akai Haato X(twitter)</th></tr></thead><tbody><tr><td><blockquote class=twitter-tweet><p lang=ja dir=ltr>/／<br>📢 本日２１：００から‼️<br>\＼<br><br>赤井はあと生誕3D LIVE開催!!🎊<br><br>🎁テーマはホラー⁉️<br>🎁ゲスト多数&告知あり◎<br>🎁演出はこだわり満天🥳<br><br>ダンスや歌も精一杯がんばったので<br>みんな是非！見に来てねっ❕👀✨<a href="https://twitter.com/hashtag/%E8%B5%A4%E4%BA%95%E3%81%AF%E3%81%82%E3%81%A8%E7%88%86%E8%AA%95%E7%A5%AD2025?src=hash&amp;ref_src=twsrc%5Etfw">#赤井はあと爆誕祭2025</a><br><br>【開催場所】<a href=https://t.co/3IUA2stYWi>https://t.co/3IUA2stYWi</a>… <a href=https://t.co/A1OqUBCbsM>pic.twitter.com/A1OqUBCbsM</a></p>&mdash; 赤井はあと❤️‍🔥旅するアイドル (@akaihaato) <a href="https://twitter.com/akaihaato/status/1954294114519851374?ref_src=twsrc%5Etfw">August 9, 2025</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></td><td><blockquote class=twitter-tweet><p lang=ja dir=ltr>四万温泉ステキな場所でした。<br>ぐんまー帝国、ありがとん❤️‍🔥 <a href=https://t.co/Ov0CwFRF7V>pic.twitter.com/Ov0CwFRF7V</a></p>&mdash; 赤井はあと❤️‍🔥旅するアイドル (@akaihaato) <a href="https://twitter.com/akaihaato/status/1916078150804799563?ref_src=twsrc%5Etfw">April 26, 2025</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></td></tr></tbody></table><p>プログラムを開発する際には、以下の鉄則に従いました。</p><ul><li>デスクトップ環境においていかなるアーキテクチャ差別があってはならない。</li><li>MSやAppleの開発エコシステムに最小限しか縛られないこと。</li><li>リソースを多く使ってはならず、高速でなければならない。</li></ul><p>目標は大層なもののように見えますが、単に自分がRustマニアだからこうなっただけです。</p><hr><h2 class="relative group">始まり：EXIFフレームをもっと手軽に<div id=始まりexifフレームをもっと手軽に class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%a7%8b%e3%81%be%e3%82%8aexif%e3%83%95%e3%83%ac%e3%83%bc%e3%83%a0%e3%82%92%e3%82%82%e3%81%a3%e3%81%a8%e6%89%8b%e8%bb%bd%e3%81%ab aria-label=アンカー>#</a></span></h2><p>最初から大掛かりなクロスプラットフォームアプリを計画していたわけではありませんでした。</p><p>カメラ好きの間では、写真を投稿する際にEXIF情報をもとにカメラ機種名、レンズ、シャッタースピードなどをフレームに入れて共有する文化があります。自分もこの方法を愛用しており、既存の <a href=https://github.com/jeonghyeon-net/exif-frame target=_blank rel=noreferrer>exif-frame</a> というWeb上のツールを参考にしていました。しかしHEIFフォーマットに対応していない点や高解像度画像出力に制限がある点が惜しく、自分で作ろうという考えからChama Opticsが始まりました。</p><p>最初は<strong>デスクトップだけを想定</strong>していました。モバイルへの漠然としたイメージはありましたが、旅先でもいつもMacBookを持ち歩いていたのでモバイルは全く念頭にありませんでした。カメラからSDカードを抜き、MacBookで写真を整理し、フレームをかぶせてアップロードする――そのワークフローが当たり前だったからです。</p><hr><h2 class="relative group">方向転換：「会場でMacBookは開けないだろ」<div id=方向転換会場でmacbookは開けないだろ class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e6%96%b9%e5%90%91%e8%bb%a2%e6%8f%9b%e4%bc%9a%e5%a0%b4%e3%81%a7macbook%e3%81%af%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e3%81%a0%e3%82%8d aria-label=アンカー>#</a></span></h2><p>方向が変わったのには二つのきっかけがありました。</p><h3 class="relative group">イベント文化の違い ―― AnimeNYCで感じたこと<div id=イベント文化の違い--animenycで感じたこと class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%82%a4%e3%83%99%e3%83%b3%e3%83%88%e6%96%87%e5%8c%96%e3%81%ae%e9%81%95%e3%81%84--animenyc%e3%81%a7%e6%84%9f%e3%81%98%e3%81%9f%e3%81%93%e3%81%a8 aria-label=アンカー>#</a></span></h3><p>2025年8月、<strong>AnimeNYC</strong> と <strong>Hololive World Tour / EN Concert</strong> のために米国を訪れました。その時面白い違いに気づきました。米国ではイベント会場で撮った写真を投稿する際、<strong>他人の顔をモザイクしない傾向</strong>が強かったです。しかし韓国や日本のイベントでは、<strong>他人の顔を必ずモザイク処理する</strong>のがマナーであり暗黙のルールでした。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=auto alt="AnimeNYC イベント写真の例" width=4072 height=2852 src=/en/posts/chama-optics-dev-story/P1090028-OPTICS_hu_8d712446ebc299fb.webp srcset="/en/posts/chama-optics-dev-story/P1090028-OPTICS_hu_8d712446ebc299fb.webp 800w, /en/posts/chama-optics-dev-story/P1090028-OPTICS_hu_b596c2480f9c7781.webp 1280w" sizes="(min-width: 768px) 50vw, 65vw" data-zoom-src=/en/posts/chama-optics-dev-story/P1090028-OPTICS.webp></figure></p><p>「他人の顔のモザイク」は毎回手作業でやるにはあまりにも面倒な作業です。特に写真が数十枚、数百枚になればなおさらです。<strong>顔の自動認識＋モザイク/ステッカー機能</strong>が必要だという思いがこの時から強くなりました。</p><h3 class="relative group">間もなく開催のホロライブエキスポ<div id=間もなく開催のホロライブエキスポ class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e9%96%93%e3%82%82%e3%81%aa%e3%81%8f%e9%96%8b%e5%82%ac%e3%81%ae%e3%83%9b%e3%83%ad%e3%83%a9%e3%82%a4%e3%83%96%e3%82%a8%e3%82%ad%e3%82%b9%e3%83%9d aria-label=アンカー>#</a></span></h3><p>もう一つの動機は <strong>2026年3月のホロライブエキスポ/フェスティバル</strong> でした。会場ですぐ写真を撮り、その場でフレームをかぶせ、モザイクまで処理してSNSに上げられたら？　でも会場でMacBookは開けません。<strong>スマートフォンですぐ処理できなければなりませんでした。</strong></p><h3 class="relative group">周囲からのリクエスト<div id=周囲からのリクエスト class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%91%a8%e5%9b%b2%e3%81%8b%e3%82%89%e3%81%ae%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88 aria-label=アンカー>#</a></span></h3><p>さらに周囲から <strong>iOS版開発へのリクエスト</strong> が加わりました。そこでiOS版を開発し始めたら、今度は <strong>Android版へのリクエスト</strong> も来ました。</p><p>こうしてデスクトップ専用だったプログラムがiOS、さらにAndroidまでサポートする方向へ拡張されました。モバイルではミラーレスカメラユーザーよりも<strong>一般ユーザーの体験</strong>をより重視する設計方針としました。EXIFフレームという出発点はそのままですが、「イベント現場で素早く写真を処理して共有する」という新しいユースケースが加わったわけです。</p><hr><h2 class="relative group">アーキテクチャ：デスクトップからモバイルへ<div id=アーキテクチャデスクトップからモバイルへ class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%82%a2%e3%83%bc%e3%82%ad%e3%83%86%e3%82%af%e3%83%81%e3%83%a3%e3%83%87%e3%82%b9%e3%82%af%e3%83%88%e3%83%83%e3%83%97%e3%81%8b%e3%82%89%e3%83%a2%e3%83%90%e3%82%a4%e3%83%ab%e3%81%b8 aria-label=アンカー>#</a></span></h2><p>最初はRust + eguiでデスクトップアプリだけを作るつもりでした。だからコアロジックをすべてRustで書いたことが、結果的に良い選択となりました。iOS/Androidへ拡張する際に、<strong>画像処理、EXIFパース、テーマレンダリング、エンコード/デコードといったコアコードをそのまま再利用</strong>できたからです。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="ChamaOptics Architecture" src=/en/posts/chama-optics-dev-story/architecture_layers.svg></figure></p><p>デスクトップではRustコアを<strong>直接リンク</strong>して使い、iOSでは <strong>C FFIを通じてSwiftから呼び出し</strong>、Androidでは <strong>JNA（Java Native Access）を通じてKotlinから呼び出す</strong> 構造です。Rustコアはgit submoduleで管理され、EXIF解析、画像オーバーレイ（テキスト、EXIF、余白、スケーリング、エンコード/デコード）といったコア機能をすべてのプラットフォームで共有します。</p><p>ただし、顔認識だけはプラットフォームごとに異なる戦略を使います。</p><ul><li><strong>デスクトップ（macOS/Windows/Linux）</strong>: ONNX Runtime + InsightFace（SCRFD det_10g）モデル。Speed Modeに応じて640×640固定入力サイズのスライディングウィンドウを多段階（2560/1280/640）に適用して小さな顔まで検出し、NMSで重複を除去するパイプライン</li><li><strong>iOS</strong>: Apple Vision Frameworkをネイティブで使用。ONNXモデルなしでも高速・高精度で、プライバシー面でも有利</li><li><strong>Android</strong>: Google ML Kit（<code>com.google.mlkit:face-detection</code>）を活用 ―― Googleが提供するオンデバイス顔認識ライブラリ、Rustコアのspeed_modeをFAST/ACCURATEパフォーマンスモードにマッピング</li></ul><hr><h2 class="relative group">Web版を断念した理由<div id=web版を断念した理由 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#web%e7%89%88%e3%82%92%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%9f%e7%90%86%e7%94%b1 aria-label=アンカー>#</a></span></h2><p>自分はWeb Appやブラウザの動作の仕組みに詳しくありません。それでもChama Opticsは当初、<strong>Web（WASM）での動作を念頭に置いていました。</strong> eguiがWASMをサポートしているから「デスクトップとWebが同時にいけるだろう」という漠然とした期待がありました。しかし次の二つの機能を実装しようとして断念しました。</p><ul><li><strong>HEIFデコード</strong></li><li><strong>egui WebでのDrag & Drop</strong></li></ul><h3 class="relative group">HEIF：WASMの上にWASM、その間にJS<div id=heifwasmの上にwasmその間にjs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#heifwasm%e3%81%ae%e4%b8%8a%e3%81%abwasm%e3%81%9d%e3%81%ae%e9%96%93%e3%81%abjs aria-label=アンカー>#</a></span></h3><p>libheifをブラウザで動かすのが難しいこと以前に、根本的な構造が腑に落ちませんでした。libheifはすでにWASMにコンパイルされた状態で、eguiアプリもWASMです。この二つの間の通信を<strong>JavaScriptを介したFFIで何度も経由しなければならない</strong>ということが理解できませんでした。ほとんどの言語間FFIはCベースで行うのに対し、なぜJSエコシステムではこうしなければならないのか理解できませんでした。</p><h3 class="relative group">Drag & Drop：デスクトップ開発者の期待と現実<div id=drag--dropデスクトップ開発者の期待と現実 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#drag--drop%e3%83%87%e3%82%b9%e3%82%af%e3%83%88%e3%83%83%e3%83%97%e9%96%8b%e7%99%ba%e8%80%85%e3%81%ae%e6%9c%9f%e5%be%85%e3%81%a8%e7%8f%be%e5%ae%9f aria-label=アンカー>#</a></span></h3><p>Drag & Drop以外にも、WASMがブラウザからイベントを受け取る際にJSではなくDOMをバイナリ形態で受け取るとか、もっと従来のデスクトップ/組み込み開発で使われるような方法が提供されると思っていましたが、そうではありませんでした。</p><h3 class="relative group">正直、CとRustしか使えない<div id=正直cとrustしか使えない class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e6%ad%a3%e7%9b%b4c%e3%81%a8rust%e3%81%97%e3%81%8b%e4%bd%bf%e3%81%88%e3%81%aa%e3%81%84 aria-label=アンカー>#</a></span></h3><p>自分は<strong>CとRustしか使えません。</strong>　つまり、Web開発そのものに対して非常に無知であるか、過去にやったとしても変な方法で開発していました。</p><p>以前、大量のデータをWebに並べる必要があったとき、どうすればいいか分からず、データをCSVにして <code>,</code> と <code>\n</code> を <code>&lt;div></code> などのHTMLタグに置き換えるのを<strong>hexエディタで一括置換</strong>してstatic webを作りデプロイしたことがあります。21世紀が25%も過ぎた現代のプログラム開発において、自分でも「これは何だ」と思いました。</p><p>もちろんWASMはWebなので、Webエコシステムと開発者のやり方に従うのが一般的でしょう。しかし自分はWeb開発者ではないため理解できませんでした。自分は<strong>JS/Webエコシステムとはかけ離れた存在</strong>で、こうした開発環境自体の方向性の違いを克服するよりも、ネイティブモバイルアプリを作る方がよほど自然でした。v0.1.9-betaで正式にWASMサポートを削除し、そのエネルギーをiOS/Androidネイティブに注ぐことにしました。</p><hr><h2 class="relative group">タイムラインで見る開発の旅<div id=タイムラインで見る開発の旅 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%82%bf%e3%82%a4%e3%83%a0%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%a7%e8%a6%8b%e3%82%8b%e9%96%8b%e7%99%ba%e3%81%ae%e6%97%85 aria-label=アンカー>#</a></span></h2><h3 class="relative group">v0.1.0~v0.1.1 (2025-10-19~21) ―― 初のプレリリース<div id=v010v011-2025-10-1921--初のプレリリース class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#v010v011-2025-10-1921--%e5%88%9d%e3%81%ae%e3%83%97%e3%83%ac%e3%83%aa%e3%83%aa%e3%83%bc%e3%82%b9 aria-label=アンカー>#</a></span></h3><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="v0.1.0 スクリーンショット" src=https://github.com/user-attachments/assets/2471db65-8b0b-44e4-9d2b-31701184878e></figure></p><p>macOS/Windowsバイナリ初配布。Filmテーマフレーム、日本語翻訳、一括保存、ファイル名プレフィックス/サフィックス設定。macOSコード署名DMG配布および日/英/韓インストールガイドWiki作成。</p><h3 class="relative group">v0.1.2~v0.1.6 (2025-10-27~11-24) ―― テーマ拡張とウォーターマーク<div id=v012v016-2025-10-2711-24--テーマ拡張とウォーターマーク class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#v012v016-2025-10-2711-24--%e3%83%86%e3%83%bc%e3%83%9e%e6%8b%a1%e5%bc%b5%e3%81%a8%e3%82%a6%e3%82%a9%e3%83%bc%e3%82%bf%e3%83%bc%e3%83%9e%e3%83%bc%e3%82%af aria-label=アンカー>#</a></span></h3><table><thead><tr><th style=text-align:center>Film Date テーマ</th><th style=text-align:center>Strap テーマ</th><th style=text-align:center>Monitor テーマ</th><th style=text-align:center>Lightroom テーマ</th></tr></thead><tbody><tr><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Film Date" src=https://github.com/user-attachments/assets/a6bf0e51-d3b1-4779-9d65-080b225958f4></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Strap src=https://github.com/user-attachments/assets/039ab49f-85b1-414b-95e3-2da166cea27f></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Monitor src=https://github.com/user-attachments/assets/e92b81a0-4465-4dad-9097-7e8b4814fc15></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Lightroom src=https://github.com/user-attachments/assets/ce1022cd-aea3-4260-9d5f-5e15997388de></figure></td></tr></tbody></table><p>Film Date/Film Glow/Just Frame/Strap/Monitor/Lightroom テーマ追加。ウォーターマーク（9箇所の位置、透明度、ブレンドモード）、フォント選択（内蔵＋OSフォント）、内蔵カメラメーカーロゴ自動適用、HEIF方向修正、可変フォント初期サポート、Longsideスケールオプション。</p><h3 class="relative group">v0.1.7 (2025-11-26~12-19) ―― CJKレンダリング改善とオープンソース貢献<div id=v017-2025-11-2612-19--cjkレンダリング改善とオープンソース貢献 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#v017-2025-11-2612-19--cjk%e3%83%ac%e3%83%b3%e3%83%80%e3%83%aa%e3%83%b3%e3%82%b0%e6%94%b9%e5%96%84%e3%81%a8%e3%82%aa%e3%83%bc%e3%83%97%e3%83%b3%e3%82%bd%e3%83%bc%e3%82%b9%e8%b2%a2%e7%8c%ae aria-label=アンカー>#</a></span></h3><table><thead><tr><th style=text-align:center>One Line テーマ</th><th style=text-align:center>Shot On Two Line テーマ</th></tr></thead><tbody><tr><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="One Line" src=https://github.com/user-attachments/assets/337337f3-7c17-467a-b965-06481cba98c8></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Shot On 2" src=https://github.com/user-attachments/assets/a9ba4540-6540-418c-8e21-4f9961d7bff7></figure></td></tr></tbody></table><table><thead><tr><th style=text-align:center>Nikon PhotoStyle</th><th style=text-align:center>Lumix Photo Style + LUT</th></tr></thead><tbody><tr><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Nikon src=https://github.com/user-attachments/assets/28016fd2-2d4d-4043-88e1-c29f7577a32a></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Lumix src=https://github.com/user-attachments/assets/62219e6a-c6cb-49ac-9803-cda29321b998></figure></td></tr></tbody></table><p>One Line/Two Line/Shot Onテーマ。CJKグリフレンダリングの大幅改善およびSourceHanSans fallback内蔵。Lumix LUT名・Nikon PhotoStyle名をEXIFから抽出するため <a href=https://github.com/kamadak/exif-rs target=_blank rel=noreferrer>exif-rs</a> にPRを提出し先行反映。</p><h3 class="relative group">v0.1.8 (2025-12-25~27) ―― UIリニューアルとパフォーマンス改善<div id=v018-2025-12-2527--uiリニューアルとパフォーマンス改善 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#v018-2025-12-2527--ui%e3%83%aa%e3%83%8b%e3%83%a5%e3%83%bc%e3%82%a2%e3%83%ab%e3%81%a8%e3%83%91%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%b3%e3%82%b9%e6%94%b9%e5%96%84 aria-label=アンカー>#</a></span></h3><table><thead><tr><th style=text-align:center>画像リストタブ</th><th style=text-align:center>テーマ設定タブ</th></tr></thead><tbody><tr><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Tab1 src=https://github.com/user-attachments/assets/798d9c93-833a-4e9f-876d-ee3fe7182dab></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Tab2 src=https://github.com/user-attachments/assets/4dd969fa-6f75-4f73-8c8a-f89ac66e1b1b></figure></td></tr></tbody></table><p>タブベースインターフェースへの切り替え（4タブ）、EXIF変数オートコンプリート、画像自動グループ化、2MP MPFプレビューベースのテーマプレビュー、Rayonマルチコア並列処理、システムフォント読み込みメモリ問題の修正。<a href=https://github.com/emilk/egui target=_blank rel=noreferrer>egui</a> にもPRを提出。</p><h3 class="relative group">v0.1.9 (2026-01-18~02-04) ―― 顔認識、LUT、iOS初配布<div id=v019-2026-01-1802-04--顔認識lutios初配布 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#v019-2026-01-1802-04--%e9%a1%94%e8%aa%8d%e8%ad%98lutios%e5%88%9d%e9%85%8d%e5%b8%83 aria-label=アンカー>#</a></span></h3><table><thead><tr><th style=text-align:center>顔認識（デスクトップ）</th><th style=text-align:center>モザイク適用</th></tr></thead><tbody><tr><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Face Detection" src=https://github.com/user-attachments/assets/a038cdaa-f755-4d8f-97c9-71f57004e739></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=Mosaic src=https://github.com/user-attachments/assets/6ed05280-1980-448a-9243-aff0836d2470></figure></td></tr></tbody></table><table><thead><tr><th style=text-align:center>カラーグレーディングUI</th><th style=text-align:center>LUT適用結果</th></tr></thead><tbody><tr><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="LUT UI" src=https://github.com/user-attachments/assets/554f96b2-217a-4603-93f5-1df41309f77e></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="LUT Result" src=https://github.com/user-attachments/assets/4d49174c-2624-4b3c-a8a1-fc2b56d357c1></figure></td></tr></tbody></table><table><thead><tr><th style=text-align:center>iOS ギャラリー</th><th style=text-align:center>iOS 編集</th></tr></thead><tbody><tr><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=auto alt=Gallery width=2412 height=1311 src=/en/posts/chama-optics-dev-story/previews-d2OPTICS_hu_1ac30e400eb3a375.webp srcset="/en/posts/chama-optics-dev-story/previews-d2OPTICS_hu_1ac30e400eb3a375.webp 800w, /en/posts/chama-optics-dev-story/previews-d2OPTICS_hu_92f7456d73efcbec.webp 1280w" sizes="(min-width: 768px) 50vw, 65vw" data-zoom-src=/en/posts/chama-optics-dev-story/previews-d2OPTICS.webp></figure></td><td style=text-align:center><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=auto alt=Editor width=2412 height=1311 src=/en/posts/chama-optics-dev-story/color-themes-d2OPTICS_hu_d6a28de598a9adb.webp srcset="/en/posts/chama-optics-dev-story/color-themes-d2OPTICS_hu_d6a28de598a9adb.webp 800w, /en/posts/chama-optics-dev-story/color-themes-d2OPTICS_hu_e12507295bd67776.webp 1280w" sizes="(min-width: 768px) 50vw, 65vw" data-zoom-src=/en/posts/chama-optics-dev-story/color-themes-d2OPTICS.webp></figure></td></tr></tbody></table><p>デスクトップ単独リリースの最終版であり、iOSアプリ初配布バージョンです。ONNX（InsightFace）顔検出＋モザイク/ストローク/ステッカーオーバーレイ。1D/3D LUTカラーグレーディング（<a href=https://github.com/pmnxis/wagahai-lut target=_blank rel=noreferrer>wagahai-lut</a>）。iOSはSwiftUI + Vision Frameworkネイティブ顔認識、Rust FFIブリッジ（<code>ffi_ios.rs</code> + <code>RustBridge.swift</code>）。インドネシア語翻訳追加。</p><hr><h2 class="relative group">技術的チャレンジと解決策<div id=技術的チャレンジと解決策 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e6%8a%80%e8%a1%93%e7%9a%84%e3%83%81%e3%83%a3%e3%83%ac%e3%83%b3%e3%82%b8%e3%81%a8%e8%a7%a3%e6%b1%ba%e7%ad%96 aria-label=アンカー>#</a></span></h2><p>プロジェクト全般にわたって適用されたパフォーマンス戦略をまず整理すると以下の通りです。</p><ul><li><strong>Rayon並列処理</strong> ―― 大量画像の一括エクスポート時にマルチコアを活用。ただし、色補正などピクセル単位の処理では10万ピクセル以上の場合のみ <code>par_chunks_exact_mut()</code> で並列化し、小さい画像はコンテキストスイッチのオーバーヘッドを避けるため逐次処理します。</li><li><strong><code>fast_image_resize</code> ベースのリサイズ</strong> ―― <code>image</code> クレートのデフォルトリサイズの代わりにSIMD最適化された <code>fast_image_resize</code> を使用し、サムネイル生成やプレビューリサイズの速度を大幅に改善</li><li><strong>Lazyロードとキャッシュ</strong> ―― LUTファイルは <code>lut_cache: HashMap&lt;Uuid, CubeLut></code> に初回使用時にパースしてキャッシュし、EXIFサムネイルも <code>thumbnail_cache</code> に遅延ロードします。バックグラウンドスレッド用の複製（<code>clone_for_thread()</code>）時にはキャッシュを除外し、不要なメモリ複製を防止します。</li><li><strong>パーセプチュアルハッシュベースの画像グループ化</strong> ―― 画像ロード時に8×8グレースケール平均ハッシュ（64-bit）を事前計算し、その後の類似画像グループ化をハミング距離O(1)比較で実行。元画像を再ロードせずメタデータだけでグループ化します。</li><li><strong>ビルドプロファイル最適化</strong> ―― Releaseビルドで <code>opt-level = 3</code>、<code>lto = "fat"</code>、<code>codegen-units = 1</code> を適用し、Devビルドでも <code>fast_image_resize</code>、<code>mozjpeg</code>、<code>ab_glyph</code> などパフォーマンスに敏感な依存関係は <code>opt-level = 3</code> で個別設定して、デバッグ中でも画像処理パフォーマンスを維持します。</li></ul><h3 class="relative group">1. クロスプラットフォームFFIの複雑さ<div id=1-クロスプラットフォームffiの複雑さ class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#1-%e3%82%af%e3%83%ad%e3%82%b9%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%a0ffi%e3%81%ae%e8%a4%87%e9%9b%91%e3%81%95 aria-label=アンカー>#</a></span></h3><p>Rustコアを3つのプラットフォーム（デスクトップ/iOS/Android）で使うために、それぞれ異なるFFI戦略を採用しました。</p><table><thead><tr><th style=text-align:left>プラットフォーム</th><th style=text-align:left>FFI方式</th><th style=text-align:left>特徴</th></tr></thead><tbody><tr><td style=text-align:left>デスクトップ (egui)</td><td style=text-align:left>直接リンク</td><td style=text-align:left>Rust → Rust、FFI不要</td></tr><tr><td style=text-align:left>iOS (SwiftUI)</td><td style=text-align:left>C FFI (<code>@_silgen_name</code>)</td><td style=text-align:left>SwiftからC関数を直接呼び出し</td></tr><tr><td style=text-align:left>Android (Compose)</td><td style=text-align:left>JNA (Java Native Access)</td><td style=text-align:left>KotlinからJNA経由で.soを呼び出し</td></tr></tbody></table><p>このブリッジレイヤーをメンテナンスしつつも安定したメモリ管理（文字列の割り当て/解放、不透明ポインタハンドルパターン）を保証することが主な課題でした。</p><h3 class="relative group">2. EXIFパースの尽きない変数<div id=2-exifパースの尽きない変数 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#2-exif%e3%83%91%e3%83%bc%e3%82%b9%e3%81%ae%e5%b0%bd%e3%81%8d%e3%81%aa%e3%81%84%e5%a4%89%e6%95%b0 aria-label=アンカー>#</a></span></h3><p>カメラごとにEXIFの記録方式が異なります。</p><ul><li><strong>シャッタースピード/F値の浮動小数点問題</strong> ―― 1/125秒が <code>0.008000000</code> のような汚い値で記録される場合の自動補正</li><li><strong>HEIF/HEIC方向情報の誤り</strong> ―― 一部の画像で方向がずれる問題</li><li><strong>レンズ情報のないカメラ</strong> ―― Nikon Coolpixのようなコンパクトカメラへの対応</li><li><strong>MakerNoteに隠された情報</strong> ―― Lumix LUT名、Nikon PhotoStyle、Sony Creative Lookなどメーカー別非公開EXIFフィールドのパース</li></ul><p>これらのために <a href=https://github.com/kamadak/exif-rs target=_blank rel=noreferrer>exif-rs</a> ライブラリに直接PRを送り、必要な機能を追加しました。</p><h3 class="relative group">3. MakerNoteパース：メーカー別撮影設定の抽出<div id=3-makernoteパースメーカー別撮影設定の抽出 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#3-makernote%e3%83%91%e3%83%bc%e3%82%b9%e3%83%a1%e3%83%bc%e3%82%ab%e3%83%bc%e5%88%a5%e6%92%ae%e5%bd%b1%e8%a8%ad%e5%ae%9a%e3%81%ae%e6%8a%bd%e5%87%ba aria-label=アンカー>#</a></span></h3><p>最近のミラーレスカメラは独自の色味を合わせる機能が非常に優れています。LumixのPhoto Style、NikonのPicture Control、SonyのCreative Lookなどがそれです。写真家の間では「どの色味設定で撮ったか」がカメラ機種やレンズと同じくらい重要な情報であり、この情報をフレームに一緒に入れられたらいいなと思いました。</p><p><a href=https://www.cipa.jp/std/documents/download_e.html?DC-008-Translation-2023-E target=_blank rel=noreferrer>EXIF標準</a>の <strong>MakerNote</strong>（Tag 0x927C）は、カメラメーカーが自由に使える非標準領域です。フォーマットはメーカーごとに、さらには同じメーカーのモデルごとに異なり、ドキュメントも乏しいです。しかしここには**「どの色味設定で撮ったか」**のような、写真家にとって重要な情報が隠れています。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="MakerNote パースフロー" src=/en/posts/chama-optics-dev-story/makernote_parsing.svg></figure></p><p>Chama Opticsでは <code>exif.maker_note_vendor()</code> でメーカーを先に識別し、各メーカー専用パーサーに分岐します。</p><p><strong>Nikon</strong> ―― <code>PictureControlData</code> / <code>PictureControlData2</code> タグからPicture Control名を抽出します。<code>"VitalityFilm_Pmango"</code> のようなユーザー定義プロファイル名や、<code>"Flat"</code>、<code>"Vivid"</code> のようなプリセット名がここに格納されています。</p><p><strong>Panasonic (Lumix)</strong> ―― 最も豊富なデータを提供します。<code>PhotoStyleName</code> から基本のPhoto Style名（<code>"NostalgicKintex"</code>）を、<code>LutPrimaryFile</code>/<code>LutSecondaryFile</code> から適用されたLUTファイル名（<code>"KintexYellow33.CUBE"</code>）とGain値まで抽出します。この情報はChama OpticsのLUTカラーグレーディング機能と直接連携します。</p><p><strong>Sony</strong> ―― <code>Sony_0x9416</code> タグからCreative Style/Creative Look情報（<code>"Vivid"</code>、<code>"Standard"</code>、<code>"Portrait"</code> など）を抽出します。</p><p>このMakerNoteパース機能は既存のexif-rsになかったため、直接実装して <a href=https://github.com/kamadak/exif-rs/pull/57 target=_blank rel=noreferrer>PR #57</a> として提出しました。</p><h4 class="relative group">EXIF IFDエントリ構造とMakerNoteのoffset問題<div id=exif-ifdエントリ構造とmakernoteのoffset問題 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#exif-ifd%e3%82%a8%e3%83%b3%e3%83%88%e3%83%aa%e6%a7%8b%e9%80%a0%e3%81%a8makernote%e3%81%aeoffset%e5%95%8f%e9%a1%8c aria-label=アンカー>#</a></span></h4><p>MakerNoteをパースするには、まずEXIFのIFD（Image File Directory）構造を理解する必要があります。EXIFデータはTIFFフォーマットを基盤としており、各IFDエントリはちょうど <strong>12バイト</strong> で構成されます。</p><ul><li><strong>Tag</strong>（2バイト） ―― フィールド識別子（例：<code>0x927C</code> = MakerNote）</li><li><strong>Type</strong>（2バイト） ―― データ型</li><li><strong>Count</strong>（4バイト） ―― 値の個数</li><li><strong>Value/Offset</strong>（4バイト） ―― データが4バイト以下なら値そのもの、超過なら<strong>データ位置を指すoffset</strong></li></ul><p>標準EXIFではこのoffsetは <strong>TIFFヘッダー開始点からの距離</strong> です。シンプルで明快です。ところがMakerNote内部のIFDではこのルールが崩れます。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="EXIF IFDエントリ構造とMakerNote offset方式" src=/en/posts/chama-optics-dev-story/exif_makernote_structure.svg></figure></p><p><strong>問題はこれです</strong>：MakerNote内部にもIFDと同一構造のエントリが存在しますが、ここでのoffsetが「どこを基準にした距離か」が<strong>メーカーごとに異なります。</strong></p><ul><li><strong>TIFF-Relative方式</strong>（Panasonic、Canon、Sony、Leica、Sigma） ―― MakerNote内のoffsetが元のTIFFヘッダー開始点基準。MakerNote自体にTIFFヘッダーがなく、offsetから <code>tiff_offset</code>（TIFFスタートからMakerNoteまでの距離）を引くことで実際のデータ位置を見つけられます。</li><li><strong>MakerNote-Relative方式</strong>（Nikon、Olympus、Fujifilm、Samsung、Apple、Pentax） ―― MakerNote内のoffsetがMakerNote開始点基準。自己完結型の構造（self-contained）であり、Nikonの場合はMakerNote内に独自のTIFFヘッダーまで持っています。</li></ul><p>さらにバイトオーダー（エンディアン）もメーカーごとに異なります。Nikonは独自TIFFヘッダーから、Olympus/Appleはプロプライエタリヘッダー内の <code>"II"</code>/<code>"MM"</code> バイトから、SamsungはIFDタグ番号のパターンで自動判別します。</p><p>結局、10メーカー（Panasonic、Nikon、Sony、Canon、Olympus、Fujifilm、Samsung、Apple、Sigma、Pentax）それぞれのヘッダーフォーマット、offset補正式、バイトオーダー判別ロジックを実装し、合計23ファイル約5,900行のPRとなりました。</p><h3 class="relative group">4. カメラメーカーロゴシステム：CSV → build.rs → バイナリ埋め込み<div id=4-カメラメーカーロゴシステムcsv--buildrs--バイナリ埋め込み class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#4-%e3%82%ab%e3%83%a1%e3%83%a9%e3%83%a1%e3%83%bc%e3%82%ab%e3%83%bc%e3%83%ad%e3%82%b4%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0csv--buildrs--%e3%83%90%e3%82%a4%e3%83%8a%e3%83%aa%e5%9f%8b%e3%82%81%e8%be%bc%e3%81%bf aria-label=アンカー>#</a></span></h3><p>Strapテーマ、Filmテーマなどで写真フレームに<strong>カメラメーカーのロゴ</strong>を自動挿入するには、二つのことが必要です。(1) EXIFからメーカーを認識すること、(2) 該当メーカーのSVGロゴをレンダリングすること。</p><h4 class="relative group">コンパイルタイム：CSVからSVGダウンロード＆埋め込み<div id=コンパイルタイムcsvからsvgダウンロード埋め込み class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%e3%82%bf%e3%82%a4%e3%83%a0csv%e3%81%8b%e3%82%89svg%e3%83%80%e3%82%a6%e3%83%b3%e3%83%ad%e3%83%bc%e3%83%89%e5%9f%8b%e3%82%81%e8%be%bc%e3%81%bf aria-label=アンカー>#</a></span></h4><p>以前のRust Embedded量産プロジェクトで <a href=/ko/posts/my_first_commerical_rust_embedded_product_3/><code>const fn</code>/<code>const impl</code> でコンパイルタイムに最大限任せるアプローチ</a> と <a href=/ko/posts/my_first_commerical_rust_embedded_product_4/><code>build.rs</code> を活用したビルドスクリプト手法</a> を扱ったことがあります。Chama Opticsのロゴシステムはこの経験の延長線上で <code>build.rs</code> + <code>include_bytes!()</code> を積極活用しています。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="コンパイルタイム ロゴパイプライン" src=/en/posts/chama-optics-dev-story/logo_build_pipeline.svg></figure></p><p><code>assets/logo_mnf.csv</code> に35メーカーのロゴ情報が定義されています。<code>cargo build</code> が実行されると <code>build.rs</code> がこのCSVを読み取り、以下を実行します。</p><ol><li><strong>SVGダウンロード</strong> ―― 各行の <code>url</code> カラムからSVGを取得します。Wikimedia Commons URLならHTTPでダウンロードし、ローカルパス（<code>assets/logo_mnf/contax.svg</code>）なら直接読み込みます。ネットワーク失敗時は最大3回、5秒間隔でリトライします。</li><li><strong>MD5ハッシュ検証</strong> ―― ダウンロードしたファイルのMD5ハッシュをCSVの <code>expected_md5</code> 値と比較します。<strong>ファイルがすでに存在しハッシュが一致すれば再ダウンロードをスキップします。</strong> ハッシュが不一致なら <code>panic!</code> でビルドを中断します ―― Wikimedia側でSVGが変更された場合は意図的に確認する必要があるためです。</li><li><strong>Rustコード生成</strong> ―― <code>assets/auto_generated/logo_assets.rs</code> を生成し、各SVGを <code>include_bytes!()</code> でバイナリに埋め込みます。ランタイムでのファイルロードは不要です。</li></ol><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// 自動生成されるコード例
</span></span></span><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>LOGO_ASSETS</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=n>ArtAsset</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ArtAsset</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>key</span>: <span class=s>&#34;canon.svg&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>data</span>: <span class=nc>include_bytes</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;.../assets/download/canon.svg&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>color_type</span>: <span class=nc>ColorType</span>::<span class=n>Color</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mnf</span>: <span class=s>&#34;canon&#34;</span><span class=p>,</span><span class=w> </span><span class=n>model</span>: <span class=s>&#34;&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mnf_model_rel</span>: <span class=nc>MnfRelation</span>::<span class=n>Any</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... 35メーカー
</span></span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div><h4 class="relative group">ランタイム：EXIF → ロゴマッチング → SVGラスタライズ<div id=ランタイムexif--ロゴマッチング--svgラスタライズ class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%83%a9%e3%83%b3%e3%82%bf%e3%82%a4%e3%83%a0exif--%e3%83%ad%e3%82%b4%e3%83%9e%e3%83%83%e3%83%81%e3%83%b3%e3%82%b0--svg%e3%83%a9%e3%82%b9%e3%82%bf%e3%83%a9%e3%82%a4%e3%82%ba aria-label=アンカー>#</a></span></h4><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="ランタイム ロゴマッチング" src=/en/posts/chama-optics-dev-story/logo_runtime_matching.svg></figure></p><p>写真がロードされるとEXIFの <code>Tag::Make</code>（メーカー）と <code>Tag::Model</code>（モデル名）を抽出し、<code>LOGO_ASSETS</code> 配列を巡回してマッチングします。</p><p>マッチングルールは二つです。</p><ul><li><strong><code>MnfRelation::Any</code></strong> ―― メーカー名<strong>または</strong>モデル名のどちらか一方が一致すればよい（ほとんどの場合）</li><li><strong><code>MnfRelation::Both</code></strong> ―― メーカー名<strong>かつ</strong>モデル名の両方が一致しなければならない（特殊なケース）</li></ul><p><code>Both</code> が必要な実例：<strong>Sigma</strong> は2025年にロゴを変更しました。新ロゴを使うカメラは <code>SIGMA BF</code> モデルのみなので、CSVに <code>mnf="sigma", model="sigma bf", mnf_model_rel=Both</code> で <code>sigma2025.svg</code>（新ロゴ）を登録し、残りのSigmaカメラは <code>mnf="sigma", mnf_model_rel=Any</code> で <code>sigma.svg</code>（旧ロゴ）を使うように分離しました。</p><p>マッチングされたSVGは <code>usvg</code> でパース後 <code>resvg</code>+<code>tiny-skia</code> でラスタライズし、フレーム内の適切な位置とサイズで合成されます。<code>color_type</code>（Black/Color）と <code>fill_ops</code>（Default/Monochrome）に応じてレンダリング方式が変わり、背景色に合ったロゴ表現が可能です。</p><h3 class="relative group">5. CJKフォントレンダリングと可変フォント（Variable Font）最適化<div id=5-cjkフォントレンダリングと可変フォントvariable-font最適化 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#5-cjk%e3%83%95%e3%82%a9%e3%83%b3%e3%83%88%e3%83%ac%e3%83%b3%e3%83%80%e3%83%aa%e3%83%b3%e3%82%b0%e3%81%a8%e5%8f%af%e5%a4%89%e3%83%95%e3%82%a9%e3%83%b3%e3%83%88variable-font%e6%9c%80%e9%81%a9%e5%8c%96 aria-label=アンカー>#</a></span></h3><p>日本語・韓国語・中国語テキストを画像にレンダリングする際、多くの問題が発生しました。</p><ul><li>一部のCJK漢字（ideograph）がレンダリングされない問題</li><li>可変フォントでグリフ幅が合わない問題</li></ul><p>解決策として <strong>SourceHanSansをビルトインfallbackフォント</strong> として内蔵し、選択したフォントでサポートされないグリフを自動で代替レンダリングするようにしました。具体的にはテキストを文字単位で巡回し、主フォントで <code>GlyphId(0)</code>（グリフなし）が返された場合、SourceHanSans fallbackフォントに切り替えてレンダリングします。</p><h4 class="relative group">可変フォント weight リマッピング<div id=可変フォント-weight-リマッピング class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%8f%af%e5%a4%89%e3%83%95%e3%82%a9%e3%83%b3%e3%83%88-weight-%e3%83%aa%e3%83%9e%e3%83%83%e3%83%94%e3%83%b3%e3%82%b0 aria-label=アンカー>#</a></span></h4><p>Chama Opticsで使用する主フォント <strong>BarlowGX.ttf</strong> は可変フォント（Variable Font）ですが、内部のweight軸値が <strong>22~188</strong> という非標準範囲を使用していました。CSS標準やFreeTypeなどで使われる <strong>100~900</strong> の範囲と合わないため、<code>ab_glyph</code> で <code>set_variation(b"wght", 400.0)</code> でRegular weightを指定しても意図した結果になりませんでした。さらにデフォルトのwidthがwdth=300（Condensed）に設定されておりグリフ幅も合いませんでした。</p><p>単に <code>fvar</code>（Font Variationsメタデータ）だけ修正すればいいと思いましたが、実際のグリフ幅を保持する <code>hmtx</code> テーブルは依然としてCondensed基準でした。<strong>メタデータだけ変えてもレンダリング結果は変わりません。</strong> 結局BarlowGX.ttfから9つのweightインスタンスをwdth=500（Regular width）で抽出し、これをマスターソースとして <code>fontTools.varLib.build()</code> で可変フォントを丸ごとリビルドして解決しました。成果物が <code>Barlow-Variable-Remapped.ttf</code> と <code>Barlow-Variable-Remapped-Narrow.ttf</code> です。</p><h4 class="relative group">複数のフォントファイルを一つに統合 ―― ファイルサイズの絶対的な削減<div id=複数のフォントファイルを一つに統合--ファイルサイズの絶対的な削減 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e8%a4%87%e6%95%b0%e3%81%ae%e3%83%95%e3%82%a9%e3%83%b3%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%82%92%e4%b8%80%e3%81%a4%e3%81%ab%e7%b5%b1%e5%90%88--%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%82%b5%e3%82%a4%e3%82%ba%e3%81%ae%e7%b5%b6%e5%af%be%e7%9a%84%e3%81%aa%e5%89%8a%e6%b8%9b aria-label=アンカー>#</a></span></h4><p>可変フォントのもう一つの利点は、<strong>複数のweightファイルを一つにまとめられる</strong>ことです。従来Barlow-Thin.ttf、Barlow-Light.ttf、Barlow-Regular.ttf、Barlow-Bold.ttf、Barlow-Black.ttfなど9つ以上の静的フォントファイルが必要だったものを、可変フォント一つで置き換えられます。</p><p>CJKフォントも同様です。SourceHanSans（日中韓文字に最適な選択）は元々weight別に別ファイルが提供されますが、可変フォント版（<code>SourceHanSansVF</code>）を使えば一つのファイルで200~800範囲のweightをすべてカバーします。ただしこのフォントもBarlowGXと同じ問題があり、weight軸を標準範囲にリマッピングして <code>SourceHanSansVF-remapped.otf</code> を生成しました。</p><p>さらに <code>fontTools</code> を活用して、<strong>異なる文字集合を持つフォントを一つに統合</strong>する作業も行いました。ラテン文字フォント＋日本語フォント＋韓国語フォントを合わせて一つのファイルにでき、WOFF2解凍、TTC（Font Collection）処理、特定weightのインスタンス抽出、UTF-8ベースの文字サブセッティングなどを組み合わせて最終ファイルサイズを最小化しました。</p><p>最終的にChama Opticsに内蔵されるフォントファイルは：</p><table><thead><tr><th style=text-align:left>フォント</th><th style=text-align:right>静的フォント時の容量</th><th style=text-align:right>可変フォント容量</th><th style=text-align:left>削減</th></tr></thead><tbody><tr><td style=text-align:left><code>Barlow-Variable-Remapped.ttf</code> (100~900)</td><td style=text-align:right>~1.35 MB (9 weight)</td><td style=text-align:right><strong>385 KB</strong></td><td style=text-align:left><strong>~3.5x</strong></td></tr><tr><td style=text-align:left><code>Barlow-Variable-Remapped-Narrow.ttf</code> (100~900)</td><td style=text-align:right>~1.45 MB (9 weight)</td><td style=text-align:right><strong>207 KB</strong></td><td style=text-align:left><strong>~7x</strong></td></tr><tr><td style=text-align:left><code>SourceHanSansVF-remapped.otf</code> (200~800)</td><td style=text-align:right>~105 MB (7 weight)</td><td style=text-align:right><strong>30 MB</strong></td><td style=text-align:left><strong>~3.5x</strong></td></tr><tr><td style=text-align:left><code>DejaVuSansMono.ttf</code> (静的)</td><td style=text-align:right>—</td><td style=text-align:right>327 KB</td><td style=text-align:left>—</td></tr><tr><td style=text-align:left><code>digital-7.ttf</code> (静的)</td><td style=text-align:right>—</td><td style=text-align:right>34 KB</td><td style=text-align:left>—</td></tr><tr><td style=text-align:left><strong>合計</strong></td><td style=text-align:right><strong>~108 MB</strong></td><td style=text-align:right><strong>~31 MB</strong></td><td style=text-align:left><strong>~3.5x</strong></td></tr></tbody></table><p>Barlowの場合が特に劇的です。元のBarlowプロジェクトには 9 weight × 3 width × 2 (upright+italic) = 54個の静的TTFファイルがあり合計 <strong>8.5 MB</strong> ですが、Chama Opticsで必要な normal + narrow の2つの可変フォントは合わせて <strong>592 KB</strong> に過ぎません。モバイルアプリのバンドルサイズに敏感な環境ではこの差は決定的です。</p><h4 class="relative group">eguiでの可変フォント weightセレクティブロード<div id=eguiでの可変フォント-weightセレクティブロード class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#egui%e3%81%a7%e3%81%ae%e5%8f%af%e5%a4%89%e3%83%95%e3%82%a9%e3%83%b3%e3%83%88-weight%e3%82%bb%e3%83%ac%e3%82%af%e3%83%86%e3%82%a3%e3%83%96%e3%83%ad%e3%83%bc%e3%83%89 aria-label=アンカー>#</a></span></h4><p>デスクトップ版（egui）では可変フォントのweightを<strong>ユーザーが自由に調整</strong>できます。核心は <code>ab_glyph</code> クレートの <code>set_variation</code> APIです。</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>VariableFontPack</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>label</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span> <span class=kt>str</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>font</span>: <span class=nc>ab_glyph</span>::<span class=n>FontRef</span><span class=o>&lt;</span><span class=nb>&#39;static</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>default</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>       </span><span class=c1>// デフォルトweight（例：300）
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>start</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>         </span><span class=c1>// 最小weight（例：100）
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>end_include</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>   </span><span class=c1>// 最大weight（例：900）
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>impl</span><span class=w> </span><span class=n>VariableFontPack</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_font_by_weight</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>weight</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>ab_glyph</span>::<span class=n>FontArc</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>clamped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>weight</span><span class=p>.</span><span class=n>clamp</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>start</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>end_include</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>font</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>font</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>font</span><span class=p>.</span><span class=n>set_variation</span><span class=p>(</span><span class=sa>b</span><span class=s>&#34;wght&#34;</span><span class=p>,</span><span class=w> </span><span class=n>clamped</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f32</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>font</span><span class=p>.</span><span class=n>into</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ユーザーがテーマ設定でweightスライダーを調整すると、そのweight値で <code>set_variation(b"wght", weight)</code> を呼び出してランタイムでフォントの太さが変更されます。100（Thin）から900（Black）まで連続的な値を指定でき、350や450のような中間値も補間（interpolation）されてスムーズなweight遷移が可能です。</p><p>このロジックはデスクトップだけでなくiOS/Androidでも同様に動作します。iOSでは <code>FontSelectionView</code> で可変フォントの場合のみweightスライダーを表示し、選択されたweight値をFFI経由でRustコアに渡します。AndroidでもKotlinから <code>fontWeight</code> パラメータでRust FFIに渡す同一の構造です。</p><p>CJK fallbackもweightを反映します。主フォントがBarlow weight 700（Bold）でCJK文字が出現した場合、SourceHanSansも700に近いweightでレンダリングし、<strong>ラテン文字とCJK文字の太さが一貫して</strong>見えるようにしました。</p><h4 class="relative group">ビルトインフォントとシステムフォント<div id=ビルトインフォントとシステムフォント class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%83%93%e3%83%ab%e3%83%88%e3%82%a4%e3%83%b3%e3%83%95%e3%82%a9%e3%83%b3%e3%83%88%e3%81%a8%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%83%95%e3%82%a9%e3%83%b3%e3%83%88 aria-label=アンカー>#</a></span></h4><p>Chama Opticsで使用するフォントは二種類に分かれます。<strong>ビルトイン（builtin）フォント</strong>と<strong>システム（OS）フォント</strong>です。</p><p>ビルトインフォントはアプリにデフォルト内蔵されるフォントで、Barlow（ラテン）、SourceHanSans（CJK fallback）、D2Coding（モノスペース）、Digital-7（セグメントディスプレイスタイル）などがあります。システムフォントはユーザーのOSにインストールされたフォントを取得してテーマに適用できるようにする機能です。EXIFフレームに表示されるテキストのフォントをユーザーが自由に選択できる必要があるため、ビルトインフォントだけでは不十分です。</p><p><strong>デスクトップでは <code>include_bytes!</code> でフォントをバイナリに内蔵</strong>します。</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>FONT_BARLOW</span>: <span class=nc>BuiltInFonts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BuiltInFonts</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span>: <span class=s>&#34;Barlow&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>data</span>: <span class=nc>include_bytes</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;../../assets/fonts/Barlow-Variable-Remapped.ttf&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><p>デスクトップは実行ファイル一つで配布するのが便利なため、フォントファイルをコンパイル時にバイナリに含めます。別途のフォントディレクトリなしに実行ファイルだけですぐ動作します。</p><p>一方、<strong>iOS/Androidではフォントをファイルパスで動的ロード</strong>します。モバイルアプリはバイナリサイズに敏感で、アプリバンドル内にリソースファイルとして分離するのがプラットフォームの慣例でもあります。Swift/KotlinからFFI経由でフォントディレクトリパスをRustコアに渡すと、Rust側で <code>std::fs::read()</code> で必要なタイミングにファイルを読み込んでロードします。</p><p>システムフォントはデスクトップでのみサポートします。<code>font-kit</code> クレートの <code>SystemSource</code> を使用してOSにインストールされたフォント一覧を列挙し、ユーザーが選択したフォントをロードします。この処理はUIをブロックしないようバックグラウンドスレッドで実行し、<code>Arc&lt;RwLock&lt;Vec&lt;SystemFont>>></code> でスレッドセーフに共有します。</p><h4 class="relative group">font-kit macOS メモリ暴走のデバッグ<div id=font-kit-macos-メモリ暴走のデバッグ class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#font-kit-macos-%e3%83%a1%e3%83%a2%e3%83%aa%e6%9a%b4%e8%b5%b0%e3%81%ae%e3%83%87%e3%83%90%e3%83%83%e3%82%b0 aria-label=アンカー>#</a></span></h4><p>システムフォント列挙を実装した後、macOSで深刻な問題が発生しました。アプリ起動直後に<strong>メモリ使用量が1.0GB、ピーク1.5GBまで跳ね上がる</strong>現象でした。（<a href=https://github.com/pmnxis/chama-optics/issues/5 target=_blank rel=noreferrer>#5</a>）</p><p><code>MallocStackLogging</code> と <code>malloc_history</code> で追跡した結果、原因は <code>font-kit</code> のmacOSバックエンド（<code>core_text</code>）にありました。<code>font_kit::SystemSource::all_fonts()</code> がシステムフォント一覧を列挙する際、<strong>各フォントのファイルデータ全体をメモリに読み込んでいました</strong>：</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>435 calls for 2045941700 bytes:  ← 約2GB
</span></span><span class=line><span class=cl>  font_kit::sources::core_text::create_handles_from_core_text_collection
</span></span><span class=line><span class=cl>    font_kit::utils::slurp_file    ← フォントファイル全体をメモリに読み込み
</span></span><span class=line><span class=cl>      alloc::raw_vec::RawVecInner::try_allocate_in</span></span></code></pre></div></div><p>macOSには数百のシステムフォントがインストールされており、CJKフォント（例：Apple SD Gothic Neo、Hiraginoなど）は個別ファイルが数十MBに達します。<code>slurp_file</code> がこれらのファイルをすべてメモリに載せ、435フォントに対して約2GBを割り当てたのです。（Windowsでは同じコードで約90MB程度でした。）</p><p>解決方法は <code>font-kit</code> をフォークして <code>all_fonts()</code> 呼び出し時に<strong>フォントデータを読まずメタデータ（名前、パス）のみ収集</strong>するよう修正することでした。修正後、メモリ使用量は <strong>144.9MB</strong>（ピーク389.4MB）に大幅削減されました。</p><h3 class="relative group">6. LUTカラーグレーディング：wagahai-lutの最適化哲学<div id=6-lutカラーグレーディングwagahai-lutの最適化哲学 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#6-lut%e3%82%ab%e3%83%a9%e3%83%bc%e3%82%b0%e3%83%ac%e3%83%bc%e3%83%87%e3%82%a3%e3%83%b3%e3%82%b0wagahai-lut%e3%81%ae%e6%9c%80%e9%81%a9%e5%8c%96%e5%93%b2%e5%ad%a6 aria-label=アンカー>#</a></span></h3><p>ライブラリ名の由来は <a href=https://x.com/wagahaida_L target=_blank rel=noreferrer>wagahaida_L（ラプラス・ダークネス）</a> のツイートから取りました。</p><table><thead><tr><th>LaplusDarknesss</th><th>wagahaida_L</th></tr></thead><tbody><tr><td><blockquote class=twitter-tweet><p lang=qme dir=ltr><a href=https://t.co/dKCBGYJobj>pic.twitter.com/dKCBGYJobj</a></p>&mdash; ラプラス・ダークネス🛸💜 (@LaplusDarknesss) <a href="https://twitter.com/LaplusDarknesss/status/1940063453647147386?ref_src=twsrc%5Etfw">July 1, 2025</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></td><td><blockquote class=twitter-tweet><p lang=zxx dir=ltr><a href=https://t.co/WjplefTDWX>https://t.co/WjplefTDWX</a> <a href=https://t.co/8L19fSqYBg>pic.twitter.com/8L19fSqYBg</a></p>&mdash; ラプ様 (@wagahaida_L) <a href="https://twitter.com/wagahaida_L/status/1992881206682423708?ref_src=twsrc%5Etfw">November 24, 2025</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></td></tr></tbody></table><blockquote><p>余談ですが、v0.2.0で準備中のチェキ風（ポラロイド）画像自動生成機能もラプラス・ダークネスからアイデアを得ました。妖しく頭がいいと思います。</p></blockquote><p>v0.1.9で追加されたLUTカラーグレーディング機能は、自作の <a href=https://github.com/pmnxis/wagahai-lut target=_blank rel=noreferrer>wagahai-lut</a>（<a href=https://crates.io/crates/wagahai-lut target=_blank rel=noreferrer>crates.io</a>）ライブラリを使用します。</p><h4 class="relative group">CUBE LUTとは？<div id=cube-lutとは class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#cube-lut%e3%81%a8%e3%81%af aria-label=アンカー>#</a></span></h4><p>CUBE LUT（Look-Up Table）は <a href=https://web.archive.org/web/20220220033515/https://wwwimages2.adobe.com/content/dam/acom/en/products/speedgrade/cc/pdfs/cube-lut-specification-1.0.pdf target=_blank rel=noreferrer>Adobeが定義した <code>.cube</code> ファイルフォーマット</a> で、色変換情報を格納しています。1D LUTと3D LUTの2種類があります。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="CUBE LUT 概念" src=/en/posts/chama-optics-dev-story/lut_cube_concept.svg></figure></p><p><strong>1D LUT</strong> はR、G、B各チャンネルを独立して変換します。入力値をテーブルから探して出力値に置き換える単純な構造です。明るさ/コントラスト調整に適していますが、チャンネル間の相互作用（例：赤を青に変えること）は不可能です。テーブルサイズは通常1,024（10-bit）から65,536（16-bit）エントリで、隣接する2エントリ間の値は線形補間（linear interpolation）で計算します。</p><p><strong>3D LUT</strong> はRGB 3次元色空間全体をマッピングします。入力 (R, G, B) がまったく異なる (R&rsquo;, G&rsquo;, B&rsquo;) に変換されうるため、映画/写真のクリエイティブな色味補正（film look、color grading）に使われます。キューブ内部の格子点（lattice point）が既知のマッピングを定義し、格子点間の値は周囲8つの頂点から<strong>三線形補間</strong>（trilinear interpolation）で計算します。一般的なサイズは17³（4,913点）、33³（35,937点）、65³（274,625点）です。</p><h4 class="relative group">wagahai-lutの最適化戦略<div id=wagahai-lutの最適化戦略 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#wagahai-lut%e3%81%ae%e6%9c%80%e9%81%a9%e5%8c%96%e6%88%a6%e7%95%a5 aria-label=アンカー>#</a></span></h4><p>既存のRust LUTライブラリは汎用性に重点を置いていました。wagahai-lutは「24MP写真数十枚を一括処理しても速くなければならない」というChama Opticsの要件に合わせ、メモリレイアウトからSIMDレベルまで最適化しました。ただしx86_64とARM64の両方をサポートする必要があるため、直接アセンブリを書く代わりに <a href=https://crates.io/crates/wide target=_blank rel=noreferrer><code>wide</code></a> クレートを使用して、アーキテクチャに依存しない汎用的なベクトル最適化を選択しました。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="wagahai-lut 最適化戦略" src=/en/posts/chama-optics-dev-story/lut_optimization.svg></figure></p><p><strong>1) Structure of Arrays (SoA) メモリレイアウト</strong></p><p>一般的な3D LUT実装は <code>[Rgb, Rgb, Rgb, ...]</code> 形式のAoS（Array of Structures）レイアウトを使用します。しかし三線形補間は一度に1チャンネルずつ8頂点の値を読む必要があるため、AoSではキャッシュラインに不要なチャンネルデータが一緒にロードされます。</p><p>wagahai-lutは3D LUTを <code>r: Vec&lt;f32></code>、<code>g: Vec&lt;f32></code>、<code>b: Vec&lt;f32></code> の3つの分離された配列で格納します。このSoAレイアウトのおかげで、1チャンネルの補間に必要な8つの値がメモリ上で近くに位置し、CPUキャッシュヒット率が向上します。</p><p><strong>2) SIMD並列処理 (<code>wide::f32x4</code>)</strong></p><p>1D LUT処理では <code>wide</code> クレートの <code>f32x4</code> SIMDベクトルを使用し、R、G、B 3チャンネルの線形補間を<strong>単一ベクトル演算</strong>で実行します。4レーンのうち3つをR、G、Bに割り当て、乗算・加算が1命令で処理されます。</p><p><strong>3) 固定サイズ特殊化（Fixed-Size Specialization）</strong></p><p>1D LUTは <code>Bit10(1024)</code>、<code>Bit12(4096)</code>、<code>Bit14(16384)</code>、<code>Bit16(65536)</code> などの一般的なサイズに対して <code>Box&lt;[Rgb; SIZE]></code> 固定サイズ配列を使用します。コンパイルタイムにサイズが確定するため、境界チェック（bounds checking）をスキップして <code>get_unchecked()</code> で直接アクセスが可能です。3D LUTも17³、33³、65³のような一般的なサイズを別タイプで提供します。</p><p><strong>4) In-Place処理とループ最適化</strong></p><p><code>apply_rgb_mut()</code> / <code>apply_rgba_mut()</code> 関数は画像バッファをその場で（in-place）修正し、追加メモリ割り当てが一切ありません。ホットループではドメイン範囲の逆数（<code>inv_domain_range</code>）をループ外で事前計算し、生ポインタ（raw pointer）演算で <code>get_pixel()</code>/<code>put_pixel()</code> 呼び出しのオーバーヘッドを除去し、バイトスライスを線形に巡回してCPUキャッシュプリフェッチを最大化します。</p><h4 class="relative group">ベンチマーク結果<div id=ベンチマーク結果 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%83%99%e3%83%b3%e3%83%81%e3%83%9e%e3%83%bc%e3%82%af%e7%b5%90%e6%9e%9c aria-label=アンカー>#</a></span></h4><p>M4 Max（Stable Rust）基準の処理時間（JPEGデコード/エンコード時間含む）：</p><table><thead><tr><th style=text-align:left>解像度</th><th style=text-align:right>1D LUT</th><th style=text-align:right>3D LUT</th></tr></thead><tbody><tr><td style=text-align:left>1920×1080 (FHD)</td><td style=text-align:right>14.39 ms</td><td style=text-align:right>19.40 ms</td></tr><tr><td style=text-align:left>6000×4000 (24MP)</td><td style=text-align:right>159.91 ms</td><td style=text-align:right>223.15 ms</td></tr><tr><td style=text-align:left>8144×5424 (44MP)</td><td style=text-align:right>294.34 ms</td><td style=text-align:right>417.09 ms</td></tr></tbody></table><p>24MP写真基準で3D LUT適用が約0.22秒であり、Chama Opticsで数十枚の写真を一括処理する際にRayon並列化と組み合わせれば実用的な速度を達成できます。</p><h3 class="relative group">7. デスクトップ顔認識：Speed Modeとスライディングウィンドウアルゴリズム<div id=7-デスクトップ顔認識speed-modeとスライディングウィンドウアルゴリズム class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#7-%e3%83%87%e3%82%b9%e3%82%af%e3%83%88%e3%83%83%e3%83%97%e9%a1%94%e8%aa%8d%e8%ad%98speed-mode%e3%81%a8%e3%82%b9%e3%83%a9%e3%82%a4%e3%83%87%e3%82%a3%e3%83%b3%e3%82%b0%e3%82%a6%e3%82%a3%e3%83%b3%e3%83%89%e3%82%a6%e3%82%a2%e3%83%ab%e3%82%b4%e3%83%aa%e3%82%ba%e3%83%a0 aria-label=アンカー>#</a></span></h3><p>デスクトップではONNX Runtime + InsightFace（det_10g）モデルを使用します。このモデルの入力サイズは<strong>固定640×640ピクセル</strong>です。しかし実際の写真は24MP（6000×4000）以上であることがほとんどで、640×640に画像全体を縮小すると、人物が小さく写った集合写真では顔を見逃してしまいます。</p><p>この問題を解決するため、<strong>Speed Modeに応じた多段階スライディングウィンドウアルゴリズム</strong>を実装しました。</p><table><thead><tr><th style=text-align:left>モード</th><th style=text-align:center>max_depth</th><th style=text-align:left>Depth Loopウィンドウサイズ</th><th style=text-align:left>全体動作</th></tr></thead><tbody><tr><td style=text-align:left>Fastest</td><td style=text-align:center>0</td><td style=text-align:left>(なし)</td><td style=text-align:left>画像全体 → 640×640リサイズ → 単一推論</td></tr><tr><td style=text-align:left>Fast</td><td style=text-align:center>1</td><td style=text-align:left>(なし、depth loop未実行)</td><td style=text-align:left>+ 短辺（<code>min(W,H)</code>）サイズのスライディングウィンドウ</td></tr><tr><td style=text-align:left>Normal</td><td style=text-align:center>1</td><td style=text-align:left>640×640</td><td style=text-align:left>+ 640×640精密ウィンドウ</td></tr><tr><td style=text-align:left>Slow</td><td style=text-align:center>2</td><td style=text-align:left>1280×1280 → 640×640</td><td style=text-align:left>+ 1280→640多段階ウィンドウ</td></tr><tr><td style=text-align:left>Slowest</td><td style=text-align:center>3</td><td style=text-align:left>2560×2560 → 1280×1280 → 640×640</td><td style=text-align:left>+ 2560→1280→640全多段階ウィンドウ</td></tr></tbody></table><blockquote><p><strong>Depth Loopウィンドウサイズの公式</strong>: <code>window = 640 × 2^(max_depth - depth - 1)</code></p><p>例：Slowest(max_depth=3) → depth 0: 2560, depth 1: 1280, depth 2: 640</p></blockquote><p>アルゴリズムの流れは以下の通りです。</p><ol><li><strong>第1段階（共通）</strong>: 画像全体を640×640にリサイズして単一推論。大きな顔はこの段階で捕捉されます。</li><li><strong>第2段階（Fast以上）</strong>: 画像の短辺（<code>min(width, height)</code>）サイズのスライディングウィンドウを10%オーバーラップで移動させ、各ウィンドウを640×640に縮小して推論。異常なアスペクト比（パノラマなど）での漏れを防止します。</li><li><strong>第3段階（Normal以上）</strong>: <code>640 × 2^(max_depth - depth - 1)</code> サイズのウィンドウをdepthごとに巡回。Slowestは2560→1280→640、Slowは1280→640、Normalは640単一depth。</li><li><strong>最終</strong>: NMS（Non-Maximum Suppression、IoU閾値0.4）で重複検出を除去します。</li></ol><p>各Speed Modeの動作を視覚化したダイアグラム（6000×4000元画像基準）：</p><h4 class="relative group">Fastest<div id=fastest class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#fastest aria-label=アンカー>#</a></span></h4><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Speed Mode: Fastest" src=/en/posts/chama-optics-dev-story/speed_mode_fastest.svg></figure></p><h4 class="relative group">Fast<div id=fast class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#fast aria-label=アンカー>#</a></span></h4><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Speed Mode: Fast" src=/en/posts/chama-optics-dev-story/speed_mode_fast.svg></figure></p><h4 class="relative group">Normal<div id=normal class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#normal aria-label=アンカー>#</a></span></h4><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Speed Mode: Normal" src=/en/posts/chama-optics-dev-story/speed_mode_normal.svg></figure></p><h4 class="relative group">Slow<div id=slow class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#slow aria-label=アンカー>#</a></span></h4><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Speed Mode: Slow" src=/en/posts/chama-optics-dev-story/speed_mode_slow.svg></figure></p><h4 class="relative group">Slowest<div id=slowest class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#slowest aria-label=アンカー>#</a></span></h4><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Speed Mode: Slowest" src=/en/posts/chama-optics-dev-story/speed_mode_slowest.svg></figure></p><p>以下はSlowestモードで処理した実際のイベント写真の例です。大規模な集合写真で後列の隅にいる小さな顔まで漏れなく検出してモザイク処理した結果です。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=auto alt="Slowest モード適用例" width=4072 height=1644 src=/en/posts/chama-optics-dev-story/P1167220-OPTICS_hu_15c3e6f46edc9351.webp srcset="/en/posts/chama-optics-dev-story/P1167220-OPTICS_hu_15c3e6f46edc9351.webp 800w, /en/posts/chama-optics-dev-story/P1167220-OPTICS_hu_155c228295382ce9.webp 1280w" sizes="(min-width: 768px) 50vw, 65vw" data-zoom-src=/en/posts/chama-optics-dev-story/P1167220-OPTICS.webp></figure></p><blockquote><p>2025年AGF 天音かなた ファン集合写真会</p></blockquote><p>各モードの使用シナリオ：</p><table><thead><tr><th style=text-align:left>モード</th><th style=text-align:left>平均所要時間</th><th style=text-align:left>適した状況</th></tr></thead><tbody><tr><td style=text-align:left>Fastest</td><td style=text-align:left>~0.5秒</td><td style=text-align:left>1~2人のポートレート</td></tr><tr><td style=text-align:left>Fast</td><td style=text-align:left>~0.6秒</td><td style=text-align:left>パノラマなど異常アスペクト比の1~2人写真</td></tr><tr><td style=text-align:left>Normal</td><td style=text-align:left>~7秒</td><td style=text-align:left>約10人程度の集合写真</td></tr><tr><td style=text-align:left>Slow</td><td style=text-align:left>~13秒</td><td style=text-align:left>40~50人規模の集合写真</td></tr><tr><td style=text-align:left>Slowest</td><td style=text-align:left>~28秒</td><td style=text-align:left>50人以上の大規模集合写真</td></tr></tbody></table><p>Fastestが画像全体を640×640一つに縮小して<del>0.5秒で終わるのに対し、Slowestは2560/1280/640の3段階のウィンドウをオーバーラップさせて探索するため</del>28秒かかります。しかしイベント会場の集合写真で後列の隅の小さな顔まで捕捉するにはこの程度の探索が必要です。</p><p>実行環境（Execution Provider）もプラットフォームごとに最適化されています。</p><ul><li><strong>macOS/iOS</strong>: CoreML Execution Provider自動選択 ―― AppleのNeural Engine/GPUアクセラレーション活用</li><li><strong>Windows/Linux</strong>: CPUまたはOnnxAuto（自動検出）</li></ul><p>macOSではユーザーがCPUを選択しても内部的にCorMLに自動切り替えされ、<strong>Apple SiliconのNeural Engineを活用</strong>します。これはCPU比で数倍のパフォーマンス向上をもたらします。</p><p>一方、iOSとAndroidではこのONNXパイプラインの代わりに各プラットフォームのネイティブ顔認識APIを使用します。</p><ul><li><strong>iOS</strong>: Apple Vision Framework ―― ONNXモデルなしでも高速・高精度</li><li><strong>Android</strong>: Google ML Kit（<code>com.google.mlkit:face-detection</code>） ―― FAST/ACCURATEパフォーマンスモードをRustコアのspeed_modeにマッピング（Fastest/Fast → FASTパフォーマンス、Slow以上 → ACCURATEパフォーマンス）</li></ul><h3 class="relative group">8. iOSネイティブ統合<div id=8-iosネイティブ統合 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#8-ios%e3%83%8d%e3%82%a4%e3%83%86%e3%82%a3%e3%83%96%e7%b5%b1%e5%90%88 aria-label=アンカー>#</a></span></h3><p>iOSアプリは単にRustコアをラップするだけでなく、プラットフォームの利点を最大限に活用しました。</p><ul><li><strong>Vision Framework</strong> ―― 顔認識をiOSネイティブで処理し、ONNXモデルなしでも高速・高精度な認識</li><li><strong>PhotosUI</strong> ―― iOS写真ライブラリから直接画像を選択</li><li><strong>Metalレンダリング</strong> ―― GPUアクセラレーション画像処理</li><li><strong>iPadサポート</strong> ―― 広い画面に最適化されたレイアウト</li></ul><h3 class="relative group">9. MPFおよび内蔵プレビュー画像の抽出<div id=9-mpfおよび内蔵プレビュー画像の抽出 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#9-mpf%e3%81%8a%e3%82%88%e3%81%b3%e5%86%85%e8%94%b5%e3%83%97%e3%83%ac%e3%83%93%e3%83%a5%e3%83%bc%e7%94%bb%e5%83%8f%e3%81%ae%e6%8a%bd%e5%87%ba aria-label=アンカー>#</a></span></h3><p>JPEGファイル内に隠されたサブ画像を抽出する機能は、Chama Opticsのパフォーマンスに決定的な役割を果たします。この機能は <a href=https://github.com/kamadak/exif-rs/pull/58 target=_blank rel=noreferrer>exif-rs PR #58</a>（<a href=https://github.com/kamadak/exif-rs/pull/58 target=_blank rel=noreferrer>+1,364行</a>、PR #57ベース）で実装しました。</p><h4 class="relative group">JPEGの中に隠された画像たち<div id=jpegの中に隠された画像たち class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#jpeg%e3%81%ae%e4%b8%ad%e3%81%ab%e9%9a%a0%e3%81%95%e3%82%8c%e3%81%9f%e7%94%bb%e5%83%8f%e3%81%9f%e3%81%a1 aria-label=アンカー>#</a></span></h4><p>1つのJPEGファイルの中には実際に複数の画像が入っている可能性があります。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="JPEG ファイル構造と MPF サブ画像" src=/en/posts/chama-optics-dev-story/jpeg_mpf_structure.svg></figure></p><p>JPEG内に内蔵された画像は大きく3つのソースから抽出できます。</p><ol><li><strong>EXIF IFD(1) サムネイル</strong> ―― 標準EXIFサムネイル（通常160×120）</li><li><strong>APP2セグメント（MPF）</strong> ―― <a href=https://www.cipa.jp/std/documents/download_e.html?DC-007-Translation-2021-E target=_blank rel=noreferrer>CIPA DC-007</a> 標準で定義されたMulti-Picture Format。メインEOI以降に別の完全なJPEGストリームとして格納される。</li><li><strong>MakerNote内部プレビュー</strong> ―― メーカー別非標準プレビュー画像</li></ol><h4 class="relative group">なぜMPFプレビューが重要なのか：メモリとパフォーマンス<div id=なぜmpfプレビューが重要なのかメモリとパフォーマンス class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%81%aa%e3%81%9cmpf%e3%83%97%e3%83%ac%e3%83%93%e3%83%a5%e3%83%bc%e3%81%8c%e9%87%8d%e8%a6%81%e3%81%aa%e3%81%ae%e3%81%8b%e3%83%a1%e3%83%a2%e3%83%aa%e3%81%a8%e3%83%91%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%b3%e3%82%b9 aria-label=アンカー>#</a></span></h4><p>写真一覧でサムネイルを表示する際、最も単純な方法は<strong>元画像をロードしてリサイズ</strong>することです。しかしこれはひどく非効率的です。</p><table><thead><tr><th style=text-align:left>方式</th><th style=text-align:left>メモリ使用量</th><th style=text-align:left>処理時間</th></tr></thead><tbody><tr><td style=text-align:left>元画像(24MP)ロード → リサイズ</td><td style=text-align:left>~72MB (24M × 3bytes)</td><td style=text-align:left>遅い</td></tr><tr><td style=text-align:left>IFD(1)サムネイル使用</td><td style=text-align:left>~76KB (160×120)</td><td style=text-align:left>速いが、小さすぎてぼやける</td></tr><tr><td style=text-align:left><strong>MPFプレビュー(~2MP)使用</strong></td><td style=text-align:left><strong>~8MB</strong></td><td style=text-align:left><strong>速く、視覚的に十分</strong></td></tr></tbody></table><p>IFD(1)のサムネイルは小さすぎて一覧用には問題ありませんがプレビュー用にはぼやけます。元画像をロードすると24MP画像がメモリに<del>72MBを占有しデコード時間も長いです。**MPFに含まれる1</del>2MPプレビュー画像**はこの両者の間のスイートスポットです ―― 視覚的に十分鮮明でありながら、メモリとCPUオーバーヘッドが元画像の1/10以下です。</p><p>特にChama Opticsのように<strong>数十枚の写真を同時にリスト表示し、テーマプレビューまで提供</strong>するプログラムではこの差が決定的です。50枚の24MP写真を元画像でロードすると<del>3.6GB、MPFプレビューでロードすると</del>400MB ―― 約9倍の差です。</p><p>既存のexif-rsユーザーに影響を与えないよう <code>mpf</code> feature flagで提供するようにしました。</p><h3 class="relative group">10. HEIF/HEICデコーダ：プラットフォーム別戦略<div id=10-heifheicデコーダプラットフォーム別戦略 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#10-heifheic%e3%83%87%e3%82%b3%e3%83%bc%e3%83%80%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%a0%e5%88%a5%e6%88%a6%e7%95%a5 aria-label=アンカー>#</a></span></h3><p>最近JPEG以外にHEIF（High Efficiency Image Format）で写真を保存するデバイスが増えています。特にiOSは撮影時にHEIFをデフォルトで使用し、写真を外部に転送する際にJPEGに変換するかHEIFのまま渡すかをOSが自律的に判断します ―― アプリからこれを制御するのは容易ではありません。一部のミラーレスカメラ（Sony、Canonなど）もHEIF撮影をサポートし始めました。互換性のためにJPEGだけを使うユーザーもいますが、HEIFで入ってくるファイルを処理できなければ写真アプリとして致命的です。問題はHEIFデコードのサポートがプラットフォームごとに大きく異なることです。</p><p>Chama Opticsは<strong>可能な限りOSネイティブデコーダを使い、ネイティブサポートのないプラットフォームでのみlibheifを使う</strong>戦略を取りました。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="HEIF デコーダ戦略" src=/en/posts/chama-optics-dev-story/heif_decoder_strategy.svg></figure></p><p><strong>iOS/macOS</strong> ―― AppleのImageIO フレームワークがHEIFをネイティブサポートします。外部ライブラリなしにOS APIだけでデコードが可能です。iOSではSwiftアプリレイヤーでデコードしたピクセルバッファをC FFIでRustに渡し、macOSではRustが直接macOS APIバインディング経由で呼び出します。</p><p><strong>Android</strong> ―― API 26（Android 8.0）以上でBitmapFactoryとMediaCodecがHEIFをネイティブサポートします。Kotlinアプリでデコードした後JNA経由でRustに渡します。</p><p><strong>Windows/Linux</strong> ―― ネイティブHEIFデコーダがないか制限的です。この場合 <a href=https://crates.io/crates/libheif-rs target=_blank rel=noreferrer>libheif_rs</a>（libheifのRustバインディング）を使用します。C FFIはlibheif_rsが内部的に処理するため、Rustコードからは安全なAPIのみ呼び出せばよいです。libheifは内部的にlibde265（HEVCデコーダ）とlibaom（AV1/AVIF）を使用します。</p><p>この戦略の核心は <code>#[cfg(target_os)]</code> 条件付きコンパイルです。ネイティブデコーダがあるプラットフォームでは外部依存なしに最適なパフォーマンスを得て、libheif_rsが必要なプラットフォームでのみリンクします。結果的にmacOSビルドではlibheif関連コードはそもそもコンパイルされません。</p><h3 class="relative group">11. テーマパラメータシステム：Rust → JSON → プラットフォーム別UI<div id=11-テーマパラメータシステムrust--json--プラットフォーム別ui class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#11-%e3%83%86%e3%83%bc%e3%83%9e%e3%83%91%e3%83%a9%e3%83%a1%e3%83%bc%e3%82%bf%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0rust--json--%e3%83%97%e3%83%a9%e3%83%83%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%83%a0%e5%88%a5ui aria-label=アンカー>#</a></span></h3><p>Chama Opticsのテーマには40以上の設定パラメータがあります ―― フォントweight、ウォーターマークの位置・透明度、フレームスタイル、ロゴ表示有無、色、余白など。これらのパラメータがデスクトップとモバイルで<strong>同一の結果</strong>を保証しなければならないことが核心的な要件でした。</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=テーマパラメータシステム src=/en/posts/chama-optics-dev-story/theme_param_json.svg></figure></p><p>デスクトップ（egui）ではRust構造体を<strong>直接参照</strong>してUIウィジェットを描画します。<code>Slider::new(&amp;mut config.font_weight, 100..=900)</code> のようなコードで構造体フィールドがそのままUI状態になります ―― JSONシリアライゼーションも中間変換もありません。</p><p>問題はモバイルです。iOS（SwiftUI）とAndroid（Jetpack Compose）はRust構造体に直接アクセスできません。40以上のパラメータそれぞれについてSwift/Kotlin側で手動でUIを作り、FFIで値をやり取りするコードを一つ一つ書くとしたら？　パラメータが一つ追加されるたびにRust、Swift、Kotlinの三箇所を同時に修正しなければなりません。</p><p>この問題を <code>proc_macro</code> で解決しました。Rust構造体の定義に <code>#[derive(ThemeParam)]</code> を付けると、コンパイルタイムに以下が自動生成されます。</p><ul><li><strong>JSONスキーマ</strong>: 各フィールドのUI型（スライダー、トグル、enum選択、カラーピッカーなど）、範囲、デフォルト値を含むJSON</li><li><strong>FFI関数</strong>: <code>get_param_json()</code>、<code>set_param()</code> などモバイルから呼び出せるC ABI関数</li><li><strong>デシリアライゼーションロジック</strong>: JSONで受け取った値をRust構造体に反映するコード</li></ul><p>モバイルアプリはこのJSONをパースして<strong>ネイティブUI要素を動的に生成</strong>します。<code>"type": "slider"</code> → SwiftUIの <code>Slider</code>、Jetpack Composeの <code>Slider()</code>。<code>"type": "toggle"</code> → <code>Toggle</code> / <code>Switch</code>。ユーザーが値を変更するとFFI経由でRustコアに渡され、Rustコアは同一のレンダリングパイプラインで結果を返します。</p><p>結果的にRust構造体一つが<strong>UI仕様でありデータモデルでありシリアライゼーションフォーマット</strong>の役割を同時に果たします。新しいパラメータを追加する際はRustにフィールド一つを追加してアトリビュートでUIヒントを付ければ、proc_macroがJSONスキーマを更新し、モバイルアプリは次回ビルドで自動的にそのUIを表示します。Swift/Kotlinコードを修正する必要がありません。</p><p>組み込みでの <code>build.rs</code> 乱用と <code>const fn</code> 執着がこのような形で応用されました。正直proc_macroでやるのがスマートかどうかは分かりません ―― 本人も「異様だ」と思っている部分です。しかし<strong>40以上のパラメータを3つのプラットフォームで手動同期するよりは確実にマシです。</strong> Rustの手続き型マクロ（procedural macro）についてもっと知りたければ <a href=https://priver.dev/blog/rust/procedural-macros/ target=_blank rel=noreferrer>この記事</a> が良い参考になります。</p><hr><h2 class="relative group">オープンソース貢献活動<div id=オープンソース貢献活動 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%82%aa%e3%83%bc%e3%83%97%e3%83%b3%e3%82%bd%e3%83%bc%e3%82%b9%e8%b2%a2%e7%8c%ae%e6%b4%bb%e5%8b%95 aria-label=アンカー>#</a></span></h2><p>Chama Opticsの開発過程で依存するオープンソースプロジェクトにも積極的に貢献しました。</p><table><thead><tr><th style=text-align:left>プロジェクト</th><th style=text-align:left>貢献内容</th></tr></thead><tbody><tr><td style=text-align:left><a href=https://github.com/kamadak/exif-rs target=_blank rel=noreferrer>exif-rs</a></td><td style=text-align:left>MakerNoteパース ―― 10メーカーサポート (<a href=https://github.com/kamadak/exif-rs/pull/57 target=_blank rel=noreferrer>PR #57</a>, +5,946 lines)</td></tr><tr><td style=text-align:left><a href=https://github.com/kamadak/exif-rs target=_blank rel=noreferrer>exif-rs</a></td><td style=text-align:left>MPFおよび内蔵プレビュー画像抽出 (<a href=https://github.com/kamadak/exif-rs/pull/58 target=_blank rel=noreferrer>PR #58</a>, +1,364 lines)</td></tr><tr><td style=text-align:left><a href=https://github.com/kamadak/exif-rs target=_blank rel=noreferrer>exif-rs</a></td><td style=text-align:left>TIFFフィールドアクセス改善 (<a href=https://github.com/kamadak/exif-rs/pull/51 target=_blank rel=noreferrer>PR #51</a>, approved)</td></tr><tr><td style=text-align:left><a href=https://github.com/servo/font-kit target=_blank rel=noreferrer>font-kit</a></td><td style=text-align:left>macOSシステムフォント列挙時のメモリ暴走修正 (<a href=https://github.com/servo/font-kit/pull/271 target=_blank rel=noreferrer>PR #271</a>)</td></tr><tr><td style=text-align:left><a href=https://github.com/emilk/egui target=_blank rel=noreferrer>egui</a></td><td style=text-align:left>variable fontロード時のmain weight設定機能改善 (<a href=https://github.com/emilk/egui/pull/7790 target=_blank rel=noreferrer>PR #7790</a>, approved)</td></tr><tr><td style=text-align:left><a href=https://github.com/pmnxis/wagahai-lut target=_blank rel=noreferrer>wagahai-lut</a></td><td style=text-align:left>1D/3D LUTカラーグレーディングライブラリ (<a href=https://crates.io/crates/wagahai-lut target=_blank rel=noreferrer>crates.io</a>)</td></tr></tbody></table><hr><h2 class="relative group">リリースまとめ<div id=リリースまとめ class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%83%aa%e3%83%aa%e3%83%bc%e3%82%b9%e3%81%be%e3%81%a8%e3%82%81 aria-label=アンカー>#</a></span></h2><table><thead><tr><th style=text-align:left>バージョン</th><th style=text-align:left>日付</th><th style=text-align:left>主な変更点</th></tr></thead><tbody><tr><td style=text-align:left>v0.1.0</td><td style=text-align:left>2025-10-19</td><td style=text-align:left>初プレリリース、macOS/Windows、Filmテーマ</td></tr><tr><td style=text-align:left>v0.1.1</td><td style=text-align:left>2025-10-19</td><td style=text-align:left>日本語翻訳、一括保存、プレフィックス/サフィックス</td></tr><tr><td style=text-align:left>v0.1.2</td><td style=text-align:left>2025-10-27</td><td style=text-align:left>Glowエフェクト、Film Date/Glowテーマ</td></tr><tr><td style=text-align:left>v0.1.3</td><td style=text-align:left>2025-11-03</td><td style=text-align:left>ウォーターマーク（9箇所）、フォント選択</td></tr><tr><td style=text-align:left>v0.1.4~5</td><td style=text-align:left>2025-11-05~12</td><td style=text-align:left>Just Frame、Strapテーマ、カメラロゴ</td></tr><tr><td style=text-align:left>v0.1.6</td><td style=text-align:left>2025-11-24</td><td style=text-align:left>Monitor、Lightroomテーマ、Longsideスケール</td></tr><tr><td style=text-align:left>v0.1.7</td><td style=text-align:left>2025-12-19</td><td style=text-align:left>One/Two Line、Shot Onテーマ、CJK修正、PhotoStyle</td></tr><tr><td style=text-align:left>v0.1.8</td><td style=text-align:left>2025-12-27</td><td style=text-align:left>タブUI、グループ化、テーマプレビュー、マルチコア</td></tr><tr><td style=text-align:left>v0.1.9</td><td style=text-align:left>2026-02-04</td><td style=text-align:left>顔認識、LUTカラーグレーディング、<strong>iOS TestFlight初配布</strong></td></tr></tbody></table><hr><h2 class="relative group">AIと共にプログラミング（バイブコーディング？）<div id=aiと共にプログラミングバイブコーディング class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#ai%e3%81%a8%e5%85%b1%e3%81%ab%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%9f%e3%83%b3%e3%82%b0%e3%83%90%e3%82%a4%e3%83%96%e3%82%b3%e3%83%bc%e3%83%87%e3%82%a3%e3%83%b3%e3%82%b0 aria-label=アンカー>#</a></span></h2><p>最初はAIコーディングに対して懐疑的でした。</p><p>そのためデスクトップ版の大半は今でも自分の手書きコード + <code>cargo fmt/clippy/check</code> に依存しています。Rust Embeddedでの習慣である <code>const</code> の乱用をデスクトップでも適用しようとする自分の意図を、AI（Claude）はまだ正しく把握できていません。</p><p>しかしモバイル版を開発しながら、<strong>一人でこれを全部やるのは正気の沙汰じゃない</strong>と思いました。既存のデスクトップ版と同一の結果をモバイルで提供することが最優先であり、ネイティブAPIとRust FFIを直接呼び出す形が多くなると予想されました。</p><p>そんな折、友人の結婚式の招待状の集まりに行く際、一緒に車に乗っていた友人が「<strong>FlutterでiOS 26のLiquid UIが今まともに動かない</strong>」と言いました。開発するとしてもネイティブでのみ開発すべきだという考えが固まり、同時にAIにモバイル用のコードを任せることに決めました。</p><p>結果として <strong>Rustコアは自分が直接</strong>、<strong>モバイルUI（SwiftUI/Jetpack Compose）とFFIブリッジはAIと共に</strong> 書くという分業体制が生まれました。Rust側は自分の意図したパターンとスタイルがあるのでAIがうまく合わせられませんが、Swift/Kotlinのように自分がよく知らない言語でプラットフォームネイティブコードを書くにはAIが大いに助けになりました。</p><p>この経験をした後、Flutterのようなクロスプラットフォームフレームワークの立ち位置について考えるようになりました。もちろんFlutterやReact Nativeが解決する問題 ―― 一つのコードベースで複数プラットフォームをカバーすること ―― は依然として有効です。しかしAIが各プラットフォームのネイティブコードを十分にうまく書ける時代になれば、「ネイティブを知らないからクロスプラットフォームを選ぶ」という動機は徐々に弱まっていくかもしれません。モバイル開発をまったく知らなかった自分がAIの助けだけでSwiftUIとJetpack Composeをそれぞれネイティブで書けたという事実が、その可能性を示す一つの事例ではないかと思います。</p><hr><h2 class="relative group">今後の計画<div id=今後の計画 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e4%bb%8a%e5%be%8c%e3%81%ae%e8%a8%88%e7%94%bb aria-label=アンカー>#</a></span></h2><p>v0.1.9を起点にデスクトップ単独リリースは終了し、v0.2.0からはiOS、Androidモバイルアプリと一緒にリリースする予定です。追加機能よりは随時安定化とテーマ追加に集中するつもりです。</p><p>当面の目標は <strong>2026年3月のホロライブエキスポ/フェスティバル</strong> で実戦投入することです。会場でミラーレスで写真を撮り、iPhoneですぐフレームをかぶせ、顔を自動でモザイク処理してSNSに上げる ―― カメラユーザーでも一般のスマホユーザーでも、それぞれの環境で快適に使えるワークフローを提供するのが方向性です。</p><p>サイドプロジェクトとしてChama Opticsは「写真を撮る人が写真をより良く見せられるようサポートするツール」を目標に、もっと快適なワークフローを提供していきます。そして今回の開発で蓄積した手続き型マクロと最適化の経験をもとに、再びRust Embedded方面にももう少し力を入れていく予定です。</p><hr><h2 class="relative group">参考文献および引用<div id=参考文献および引用 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae%e3%81%8a%e3%82%88%e3%81%b3%e5%bc%95%e7%94%a8 aria-label=アンカー>#</a></span></h2><h4 class="relative group">標準文書<div id=標準文書 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e6%a8%99%e6%ba%96%e6%96%87%e6%9b%b8 aria-label=アンカー>#</a></span></h4><ul><li>CIPA DC-008 — <a href=https://www.cipa.jp/std/documents/download_e.html?DC-008-Translation-2023-E target=_blank rel=noreferrer>Exchangeable image file format (Exif) Version 3.0</a></li><li>CIPA DC-007 — <a href=https://www.cipa.jp/std/documents/download_e.html?DC-007-Translation-2021-E target=_blank rel=noreferrer>Multi-Picture Format (MPF)</a></li><li>Adobe — <a href=https://web.archive.org/web/20220220033515/https://wwwimages2.adobe.com/content/dam/acom/en/products/speedgrade/cc/pdfs/cube-lut-specification-1.0.pdf target=_blank rel=noreferrer>Adobe Cube LUT Spec 1.0</a></li></ul><h4 class="relative group">ライブラリおよびフレームワーク<div id=ライブラリおよびフレームワーク class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e3%83%a9%e3%82%a4%e3%83%96%e3%83%a9%e3%83%aa%e3%81%8a%e3%82%88%e3%81%b3%e3%83%95%e3%83%ac%e3%83%bc%e3%83%a0%e3%83%af%e3%83%bc%e3%82%af aria-label=アンカー>#</a></span></h4><ul><li><a href=https://github.com/kamadak/exif-rs target=_blank rel=noreferrer>exif-rs</a> — Rust EXIFパースライブラリ</li><li><a href=https://github.com/emilk/egui target=_blank rel=noreferrer>egui</a> — Rust即時モードGUIフレームワーク</li><li><a href=https://github.com/servo/font-kit target=_blank rel=noreferrer>font-kit</a> — クロスプラットフォームフォントロードライブラリ</li><li><a href=https://github.com/pmnxis/wagahai-lut target=_blank rel=noreferrer>wagahai-lut</a> (<a href=https://crates.io/crates/wagahai-lut target=_blank rel=noreferrer>crates.io</a>) — 1D/3D LUTカラーグレーディングライブラリ</li><li><a href=https://crates.io/crates/libheif-rs target=_blank rel=noreferrer>libheif-rs</a> — libheif Rustバインディング</li><li><a href=https://crates.io/crates/wide target=_blank rel=noreferrer>wide</a> — クロスプラットフォームSIMDベクトルクレート</li><li><a href=https://onnxruntime.ai/ target=_blank rel=noreferrer>ONNX Runtime</a> — クロスプラットフォームML推論エンジン</li><li><a href=https://github.com/deepinsight/insightface/tree/master/detection/scrfd target=_blank rel=noreferrer>InsightFace SCRFD</a> — 顔検出モデル (det_10g)</li><li><a href=https://github.com/jeonghyeon-net/exif-frame target=_blank rel=noreferrer>exif-frame</a> — EXIFフレームWebツール（Chama Opticsの初期参考）</li></ul><h4 class="relative group">参考資料<div id=参考資料 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#%e5%8f%82%e8%80%83%e8%b3%87%e6%96%99 aria-label=アンカー>#</a></span></h4><ul><li><a href=https://priver.dev/blog/rust/procedural-macros/ target=_blank rel=noreferrer>Rust Procedural Macros</a> — 手続き型マクロ参考</li><li><a href=https://exiftool.org/TagNames/ target=_blank rel=noreferrer>ExifTool TagNames</a> — メーカー別MakerNoteタグ参考</li><li><a href=https://exiv2.org/makernote.html target=_blank rel=noreferrer>Exiv2 MakerNote Documentation</a> — MakerNote構造およびメーカー別フォーマット参考</li></ul><hr><h2 class="relative group">Special Thanks<div id=special-thanks class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#special-thanks aria-label=アンカー>#</a></span></h2><ul><li><a href=https://github.com/SkuldNorniern target=_blank rel=noreferrer>SkuldNorniern</a> — デバッグおよび顔認識関連の支援</li><li><a href=https://github.com/miniex target=_blank rel=noreferrer>miniex</a> — フォントシステムのデバッグおよび顔認識関連の支援</li><li><a href=https://github.com/jcm7612 target=_blank rel=noreferrer>jcm7612</a> — デバッグおよびフィードバック</li><li><a href=https://x.com/shiemika324 target=_blank rel=noreferrer>shiemika324</a> — イラストおよびアイコンイラスト提供</li></ul></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://pmnxis.github.io/ja/posts/chama-optics-dev-story/&amp;title=Chama%20Optics%20%e9%96%8b%e7%99%ba%e8%a8%98" title=LinkedInでシェアする aria-label=LinkedInでシェアする><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://pmnxis.github.io/ja/posts/chama-optics-dev-story/&amp;text=Chama%20Optics%20%e9%96%8b%e7%99%ba%e8%a8%98" title=Twitterに投稿する aria-label=Twitterに投稿する><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span>
</a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://pmnxis.github.io/ja/posts/chama-optics-dev-story/&amp;resubmit=true&amp;title=Chama%20Optics%20%e9%96%8b%e7%99%ba%e8%a8%98" title=Redditに投稿する aria-label=Redditに投稿する><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://pmnxis.github.io/ja/posts/chama-optics-dev-story/&amp;quote=Chama%20Optics%20%e9%96%8b%e7%99%ba%e8%a8%98" title=Facebookでシェアする aria-label=Facebookでシェアする><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://pmnxis.github.io/ja/posts/chama-optics-dev-story/&amp;subject=Chama%20Optics%20%e9%96%8b%e7%99%ba%e8%a8%98" title=" Eメールを送る" aria-label=" Eメールを送る"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/ja/chama-optics-privacy/><span class=leading-6>Chama Optics プライバシーポリシー&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-16T00:00:00+09:00>2026年2月16日</time></span></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://utteranc.es/client.js repo=pmnxis/pmnxis.github.io issue-term=pathname label=Comment theme=dark-blue crossorigin=anonymous async></script></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=TOPへスクロール title=TOPへスクロール>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/ko/categories/ title=Categories>Categories</a></li><li class="flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/ko/tags/ title=Tags>Tags</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026</p><p class="text-xs text-neutral-500 dark:text-neutral-400"><a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a> で構築されています</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://pmnxis.github.io/ja/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=検索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="閉じる (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>