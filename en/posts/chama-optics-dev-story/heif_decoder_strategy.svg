<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 580">
  <defs>
    <marker id="ar-hf" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#546E7A"/>
    </marker>
    <marker id="ar-hf-r" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#ce422b"/>
    </marker>
    <style>
      text { font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif; }
      .title { font-size: 17px; font-weight: bold; fill: #1a1a1a; }
      .subtitle { font-size: 12px; fill: #666; }
      .label { font-size: 12px; fill: #333; }
      .label-sm { font-size: 10.5px; fill: #555; }
      .label-xs { font-size: 9.5px; fill: #777; }
      .label-bold { font-size: 12px; fill: #333; font-weight: bold; }
      .code-sm { font-family: 'JetBrains Mono', 'SF Mono', monospace; font-size: 9px; fill: #546E7A; }
    </style>
  </defs>

  <rect width="1100" height="580" rx="8" fill="#fafafa" stroke="#e0e0e0" stroke-width="1"/>

  <!-- Title -->
  <text x="550" y="28" text-anchor="middle" class="title">HEIF/HEIC Decoder Strategy by Platform</text>
  <text x="550" y="46" text-anchor="middle" class="subtitle">OS native decoder preferred — libheif (C FFI) or libheif-js (WASM) as fallback</text>

  <!-- Strategy A banner -->
  <rect x="25" y="58" width="410" height="18" rx="3" fill="#E8F5E9"/>
  <text x="230" y="72" text-anchor="middle" class="label-xs" fill="#2E7D32" font-weight="bold">Native Decoder — App layer decodes, passes pixels to Rust</text>

  <!-- Strategy B banner -->
  <rect x="445" y="58" width="630" height="18" rx="3" fill="#FFF3E0"/>
  <text x="760" y="72" text-anchor="middle" class="label-xs" fill="#E65100" font-weight="bold">Rust Core / JS Decodes — via native API binding, libheif_rs, or libheif-js (WASM)</text>

  <!-- ===== iOS Column ===== -->
  <rect x="25" y="85" width="190" height="260" rx="6" fill="#E3F2FD" stroke="#1565C0" stroke-width="1.2"/>
  <text x="120" y="105" text-anchor="middle" class="label-bold" fill="#1565C0">iOS / iPadOS</text>

  <rect x="55" y="115" width="120" height="22" rx="3" fill="white" stroke="#90CAF9"/>
  <text x="115" y="131" text-anchor="middle" class="code-sm">.heif / .heic file</text>

  <line x1="115" y1="137" x2="115" y2="152" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="35" y="156" width="160" height="24" rx="3" fill="white" stroke="#BBDEFB"/>
  <text x="115" y="173" text-anchor="middle" class="label-sm" fill="#1565C0">SwiftUI App Layer</text>

  <line x1="115" y1="180" x2="115" y2="195" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="35" y="199" width="160" height="40" rx="4" fill="#C8E6C9" stroke="#2E7D32" stroke-width="1.5"/>
  <text x="115" y="217" text-anchor="middle" class="label-bold" fill="#2E7D32">Apple ImageIO</text>
  <text x="115" y="232" text-anchor="middle" class="label-xs" fill="#2E7D32">Native — zero external deps</text>

  <line x1="115" y1="239" x2="115" y2="264" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>
  <text x="115" y="257" text-anchor="middle" class="code-sm">decoded pixels</text>

  <rect x="35" y="268" width="160" height="28" rx="3" fill="#FFF8E1" stroke="#FFC107" stroke-width="1"/>
  <text x="115" y="287" text-anchor="middle" class="code-sm" fill="#F57F17">Swift → C FFI (ffi_ios.rs)</text>

  <line x1="115" y1="296" x2="115" y2="358" stroke="#ce422b" stroke-width="1.5" marker-end="url(#ar-hf-r)"/>

  <!-- ===== Android Column ===== -->
  <rect x="225" y="85" width="190" height="260" rx="6" fill="#E8F5E9" stroke="#2E7D32" stroke-width="1.2"/>
  <text x="320" y="105" text-anchor="middle" class="label-bold" fill="#2E7D32">Android</text>

  <rect x="258" y="115" width="120" height="22" rx="3" fill="white" stroke="#A5D6A7"/>
  <text x="318" y="131" text-anchor="middle" class="code-sm">.heif / .heic file</text>

  <line x1="318" y1="137" x2="318" y2="152" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="235" y="156" width="165" height="24" rx="3" fill="white" stroke="#C8E6C9"/>
  <text x="317" y="173" text-anchor="middle" class="label-sm" fill="#2E7D32">Jetpack Compose App Layer</text>

  <line x1="317" y1="180" x2="317" y2="195" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="235" y="199" width="165" height="40" rx="4" fill="#C8E6C9" stroke="#2E7D32" stroke-width="1.5"/>
  <text x="317" y="217" text-anchor="middle" class="label-bold" fill="#2E7D32">BitmapFactory</text>
  <text x="317" y="232" text-anchor="middle" class="label-xs" fill="#2E7D32">MediaCodec (API 26+)</text>

  <line x1="317" y1="239" x2="317" y2="264" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>
  <text x="317" y="257" text-anchor="middle" class="code-sm">decoded pixels</text>

  <rect x="235" y="268" width="165" height="28" rx="3" fill="#FFF8E1" stroke="#FFC107" stroke-width="1"/>
  <text x="317" y="287" text-anchor="middle" class="code-sm" fill="#F57F17">Kotlin → JNA (ffi.rs)</text>

  <line x1="317" y1="296" x2="317" y2="358" stroke="#ce422b" stroke-width="1.5" marker-end="url(#ar-hf-r)"/>

  <!-- ===== macOS Column ===== -->
  <rect x="450" y="85" width="190" height="260" rx="6" fill="#EDE7F6" stroke="#7B1FA2" stroke-width="1.2"/>
  <text x="545" y="105" text-anchor="middle" class="label-bold" fill="#7B1FA2">macOS</text>

  <rect x="483" y="115" width="120" height="22" rx="3" fill="white" stroke="#CE93D8"/>
  <text x="543" y="131" text-anchor="middle" class="code-sm">.heif / .heic file</text>

  <line x1="543" y1="137" x2="543" y2="152" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="460" y="156" width="165" height="24" rx="3" fill="white" stroke="#CE93D8"/>
  <text x="542" y="173" text-anchor="middle" class="label-sm" fill="#7B1FA2">Rust Core (egui)</text>

  <line x1="542" y1="180" x2="542" y2="195" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>
  <text x="542" y="192" text-anchor="middle" class="code-sm">macOS API binding</text>

  <rect x="460" y="199" width="165" height="40" rx="4" fill="#C8E6C9" stroke="#2E7D32" stroke-width="1.5"/>
  <text x="542" y="217" text-anchor="middle" class="label-bold" fill="#2E7D32">Apple ImageIO</text>
  <text x="542" y="232" text-anchor="middle" class="label-xs" fill="#2E7D32">Native — no libheif needed</text>

  <line x1="542" y1="239" x2="542" y2="264" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>
  <text x="542" y="257" text-anchor="middle" class="code-sm">decoded pixels</text>

  <rect x="460" y="268" width="165" height="28" rx="3" fill="#E8F5E9" stroke="#2E7D32" stroke-width="1"/>
  <text x="542" y="287" text-anchor="middle" class="label-xs" fill="#2E7D32">Direct Rust call — no FFI overhead</text>

  <line x1="542" y1="296" x2="542" y2="358" stroke="#ce422b" stroke-width="1.5" marker-end="url(#ar-hf-r)"/>

  <!-- ===== Web (WASM) Column ===== -->
  <rect x="650" y="85" width="200" height="260" rx="6" fill="#E0F7FA" stroke="#00838F" stroke-width="1.2"/>
  <text x="750" y="105" text-anchor="middle" class="label-bold" fill="#00838F">Web (WASM)</text>

  <rect x="688" y="115" width="120" height="22" rx="3" fill="white" stroke="#80DEEA"/>
  <text x="748" y="131" text-anchor="middle" class="code-sm">.heif / .heic file</text>

  <line x1="748" y1="137" x2="748" y2="152" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="660" y="156" width="180" height="24" rx="3" fill="white" stroke="#80DEEA"/>
  <text x="750" y="173" text-anchor="middle" class="label-sm" fill="#00838F">Browser (JavaScript)</text>

  <line x1="750" y1="180" x2="750" y2="195" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>
  <text x="750" y="192" text-anchor="middle" class="code-sm">libheif-js (CDN)</text>

  <rect x="660" y="199" width="180" height="48" rx="4" fill="#E0F7FA" stroke="#00838F" stroke-width="1.5"/>
  <text x="750" y="217" text-anchor="middle" class="label-bold" fill="#00838F">libheif-js</text>
  <text x="750" y="232" text-anchor="middle" class="label-xs" fill="#00838F">OffscreenCanvas → RGBA</text>
  <text x="750" y="243" text-anchor="middle" class="label-xs" fill="#00838F">JS decode → wasm-bindgen</text>

  <line x1="750" y1="247" x2="750" y2="264" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>
  <text x="750" y="259" text-anchor="middle" class="code-sm">decoded pixels</text>

  <rect x="660" y="268" width="180" height="28" rx="3" fill="#E0F7FA" stroke="#00838F" stroke-width="1"/>
  <text x="750" y="282" text-anchor="middle" class="code-sm" fill="#00838F">JS → wasm-bindgen → Rust</text>
  <text x="750" y="293" text-anchor="middle" class="label-xs" fill="#00838F">JPEG 95% re-encode for EXIF</text>

  <line x1="750" y1="296" x2="750" y2="358" stroke="#ce422b" stroke-width="1.5" marker-end="url(#ar-hf-r)"/>

  <!-- ===== Windows/Linux Column ===== -->
  <rect x="860" y="85" width="215" height="260" rx="6" fill="#FFF3E0" stroke="#E65100" stroke-width="1.2"/>
  <text x="967" y="105" text-anchor="middle" class="label-bold" fill="#E65100">Windows / Linux / FreeBSD</text>

  <rect x="900" y="115" width="130" height="22" rx="3" fill="white" stroke="#FFCC80"/>
  <text x="965" y="131" text-anchor="middle" class="code-sm">.heif / .heic file</text>

  <line x1="965" y1="137" x2="965" y2="152" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="870" y="156" width="190" height="24" rx="3" fill="white" stroke="#FFCC80"/>
  <text x="965" y="173" text-anchor="middle" class="label-sm" fill="#E65100">Rust Core (egui)</text>

  <line x1="965" y1="180" x2="965" y2="195" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>
  <text x="965" y="192" text-anchor="middle" class="code-sm">libheif_rs</text>

  <rect x="870" y="199" width="190" height="54" rx="4" fill="#FFEBEE" stroke="#C62828" stroke-width="1.5"/>
  <text x="965" y="217" text-anchor="middle" class="label-bold" fill="#C62828">libheif_rs</text>
  <text x="965" y="232" text-anchor="middle" class="code-sm" fill="#C62828">libde265 (HEVC decoder)</text>
  <text x="965" y="246" text-anchor="middle" class="code-sm" fill="#C62828">libaom (AV1 / AVIF)</text>

  <line x1="965" y1="253" x2="965" y2="264" stroke="#546E7A" stroke-width="1" marker-end="url(#ar-hf)"/>

  <rect x="870" y="268" width="190" height="28" rx="3" fill="#FFEBEE" stroke="#C62828" stroke-width="1"/>
  <text x="965" y="282" text-anchor="middle" class="code-sm" fill="#C62828">Rust binding for libheif</text>
  <text x="965" y="293" text-anchor="middle" class="label-xs" fill="#C62828">C FFI abstracted away</text>

  <line x1="965" y1="296" x2="965" y2="358" stroke="#ce422b" stroke-width="1.5" marker-end="url(#ar-hf-r)"/>

  <!-- ===== Rust Core Bar ===== -->
  <rect x="25" y="360" width="1050" height="45" rx="6" fill="#FFEBEE" stroke="#ce422b" stroke-width="1.5"/>
  <text x="550" y="380" text-anchor="middle" class="label-bold" fill="#ce422b">Rust Core (chama-optics) — Image Processing Module</text>
  <text x="550" y="396" text-anchor="middle" class="label-xs" fill="#ce422b">Decoded pixel buffer → theme rendering, face detection, color grading, export</text>

  <!-- ===== Comparison Table ===== -->
  <rect x="25" y="420" width="1050" height="150" rx="6" fill="white" stroke="#e0e0e0" stroke-width="1"/>

  <!-- Table header -->
  <text x="45" y="440" class="label-bold" fill="#546E7A">Platform</text>
  <text x="185" y="440" class="label-bold" fill="#546E7A">HEIF Decoder</text>
  <text x="410" y="440" class="label-bold" fill="#546E7A">Bridge</text>
  <text x="700" y="440" class="label-bold" fill="#546E7A">Compile Flag</text>
  <line x1="35" y1="446" x2="1065" y2="446" stroke="#ECEFF1" stroke-width="1"/>

  <!-- Row 1: iOS -->
  <rect x="35" y="450" width="1030" height="22" rx="0" fill="#E3F2FD" fill-opacity="0.3"/>
  <text x="45" y="466" class="label-sm" fill="#1565C0">iOS / iPadOS</text>
  <text x="185" y="466" class="label-sm" fill="#2E7D32">Apple ImageIO (native)</text>
  <text x="410" y="466" class="code-sm">Swift → C FFI → Rust</text>
  <text x="700" y="466" class="code-sm">cfg(target_os = "ios")</text>

  <!-- Row 2: Android -->
  <rect x="35" y="474" width="1030" height="22" rx="0" fill="#E8F5E9" fill-opacity="0.3"/>
  <text x="45" y="490" class="label-sm" fill="#2E7D32">Android</text>
  <text x="185" y="490" class="label-sm" fill="#2E7D32">BitmapFactory (native)</text>
  <text x="410" y="490" class="code-sm">Kotlin → JNA → Rust</text>
  <text x="700" y="490" class="code-sm">cfg(target_os = "android")</text>

  <!-- Row 3: macOS -->
  <rect x="35" y="498" width="1030" height="22" rx="0" fill="#EDE7F6" fill-opacity="0.3"/>
  <text x="45" y="514" class="label-sm" fill="#7B1FA2">macOS</text>
  <text x="185" y="514" class="label-sm" fill="#2E7D32">Apple ImageIO (native)</text>
  <text x="410" y="514" class="code-sm">Rust → macOS API binding</text>
  <text x="700" y="514" class="code-sm">cfg(target_os = "macos")</text>

  <!-- Row 4: Web (WASM) -->
  <rect x="35" y="522" width="1030" height="22" rx="0" fill="#E0F7FA" fill-opacity="0.3"/>
  <text x="45" y="538" class="label-sm" fill="#00838F">Web (WASM)</text>
  <text x="185" y="538" class="label-sm" fill="#00838F">libheif-js (CDN)</text>
  <text x="410" y="538" class="code-sm">JS decode → wasm-bindgen → Rust</text>
  <text x="700" y="538" class="code-sm">cfg(feature = "web")</text>

  <!-- Row 5: Windows/Linux -->
  <rect x="35" y="546" width="1030" height="22" rx="0" fill="#FFF3E0" fill-opacity="0.3"/>
  <text x="45" y="562" class="label-sm" fill="#E65100">Windows / Linux / FreeBSD</text>
  <text x="185" y="562" class="label-sm" fill="#C62828">libheif_rs</text>
  <text x="410" y="562" class="code-sm">Rust → libheif_rs → libheif (C)</text>
  <text x="700" y="562" class="code-sm">cfg(not(target_os = "macos"))</text>
</svg>
